# Title: Preparation of data for woa survey
# Authors: Sayed Nabizada, Jarod Lapp, Christopher Jarvis, 
# Date created: 20/09/2019
# Date last changed: 25/09/2019
# Purpose: This script is for recoding variables in the whole of 
#          of Afghanistan survey data
#          indicators and composite scores are created. 

# setup analysis environment
source("./R/source.R")
library(msni19)
# character operation
ch<-as.character
chr<-as.character

coerc<-function(x){as.numeric(chr(x))}

# load data 
# data <- read_excel(master_data, sheet = "MSNA_AFG_19_parent_sheet", na = c("","NA"), guess_max = 3000)
# overall_muac_data <- read_excel(master_data, sheet = "MSNA_AFG_19_muac" , na = c("","NA"))
# overall_hh_roster <- read_excel(master_data, sheet = "MSNA_AFG_19_hh_roster" , na = c("","NA"))
# overall_death_roster <- read_excel(master_data, sheet = "MSNA_AFG_19_hh_death_roster" , na = c("","NA"))
# overall_left_roster <- read_excel( master_data, sheet = "MSNA_AFG_19_hh_left_roster" , na = c("","NA"))


# data <- read.csv("input/data/clean/MSNA_AFG_19_parent_sheet.csv",stringsAsFactors=F,na.strings = c("", "NA"), check.names = F)
# overall_muac_data <- read.csv("input/data/clean/MSNA_AFG_19_muac.csv",stringsAsFactors=F,na.strings = c("", "NA"), check.names = F)
# overall_hh_roster <- read.csv("input/data/clean/MSNA_AFG_19_hh_roster.csv",stringsAsFactors=F,na.strings = c("", "NA"), check.names = F)
# overall_death_roster <- read.csv("input/data/clean/MSNA_AFG_19_hh_death_roster.csv",stringsAsFactors=F,na.strings = c("", "NA"), check.names = F)
# overall_left_roster <- read.csv("input/data/clean/MSNA_AFG_19_hh_left_roster.csv",stringsAsFactors=F,na.strings = c("", "NA"), check.names = F)
# 

data <- read.csv("input/data/clean/complete_with_farah/MSNA_AFG_19_parent_sheet.csv",stringsAsFactors=F,na.strings = c("", "NA"), check.names = F)
overall_muac_data <- read.csv("input/data/clean/complete_with_farah/MSNA_AFG_19_muac.csv",stringsAsFactors=F,na.strings = c("", "NA"), check.names = F)
overall_hh_roster <- read.csv("input/data/clean/complete_with_farah/MSNA_AFG_19_hh_roster.csv",stringsAsFactors=F,na.strings = c("", "NA"), check.names = F)
overall_death_roster <- read.csv("input/data/clean/complete_with_farah/MSNA_AFG_19_hh_death_roster.csv",stringsAsFactors=F,na.strings = c("", "NA"), check.names = F)
overall_left_roster <- read.csv("input/data/clean/complete_with_farah/MSNA_AFG_19_hh_left_roster.csv",stringsAsFactors=F,na.strings = c("", "NA"), check.names = F)



# Temp for the data is exported out of kobo incorrectly. 
rename1 <- function(d1) {
  sub("/", ".", names(d1))
} 
data$uuid <- data$`_uuid`
names(data) <- rename1(data)
names(overall_muac_data ) <- rename1(overall_muac_data )
names(overall_hh_roster ) <- rename1(overall_hh_roster )
names(overall_death_roster ) <- rename1(overall_death_roster)
names(overall_left_roster ) <- rename1(overall_left_roster)


#  composite indicators #
# The composite indicators are a combination of different variables
# each value within a variable has a score and these need to be 
# coded for the different categories.
# Then the variables can be summed in order to get the score

# This will be done for multiple sectors.
#### Composite indicators ############
### Food Security & Agriculture ####

# FCS
data <- data %>%  
  mutate(
    # FCS
    fcs_category_class = recode(
      fcs_category,
      "poor" = 4,
      "borderline" = 2,
      "acceptable" = 0
      ),
    # HHS
    hhs_category_class = recode(
      hhs_category,
      "severe_hunger" = 4,
      "moderate_hunger" = 2,
      "little_hunger" = 0
      ),
    # Food Source
    food_source_class = case_when(
      food_source %in% c('gift', 'assistance') ~ 2, 
      food_source == 'borrowed' ~1,
      TRUE ~ 0
      ),
    # ag impact
    ag_impact_class = case_when(
      agricultural_impact_how == '76_100' ~ 3,
      agricultural_impact_how == '51_75' ~ 1,
      agricultural_impact %in% c('no', 'not_applicable') ~ 0,
      agricultural_impact_how %in% c('0_25', '26_50' ) ~ 0
      ),
    # livestock impact
    ls_impact_class = case_when(
      livestock_impact_how.livestock_died == 1 | 
        livestock_impact_how.left_unattended == 1 ~ 2, 
      livestock_impact_how.livestock_ill == 1 |
        livestock_impact_how.less_milk == 1 ~ 1,
      livestock_impact == 0 ~ 0,
      TRUE ~ 0,
      is.na(livestock_impact) ~ NA_real_
      )
    )

fsac_vars <- c("fcs_category_class", "hhs_category_class", "food_source_class", "ag_impact_class", "ls_impact_class")
data$fsac_score <- comp_score(data, fsac_vars)

data <- data %>% 
  mutate(
    fsac_severity = case_when(
      fsac_score <= 2 ~ 1, 
      fsac_score <= 5 ~ 2,
      fsac_score <= 8 ~ 3,
      fsac_score <= 16 ~ 4
    ),
    fsac_sev_high = case_when(
      fsac_severity <= 2 ~ 0,
      fsac_severity <= 4 ~ 1
      )
    )




##################################################################

### Protection ####

# First setup the variables required to calculate the indicators and then calculate them
# This way around if the weights are changed then it's all in one place.

# protection incidents

severe_prot_incidents_vars <-  c(
  "adult_prot_incidents.assaulted_with_weapon",
  "child_prot_incidents.assaulted_with_weapon",
  "adult_prot_incidents.forced_work",
  "child_prot_incidents.forced_work",
  "adult_prot_incidents.forcibly_detained",
  "child_prot_incidents.forcibly_detained",
  "adult_prot_incidents.hindered_leave_settlement",
  "child_prot_incidents.hindered_leave_settlement",
  #### added from less_severe_prot_incidents
  "adult_prot_incidents.verbally_threatened",
  "child_prot_incidents.verbally_threatened",
  "adult_prot_incidents.assaulted_without_weapon",
  "child_prot_incidents.assaulted_without_weapon",
  "adult_prot_incidents.hindered_leave_district",
  "child_prot_incidents.hindered_leave_district"
  )

# less_severe_prot_incidents_vars <-c(
#   "adult_prot_incidents.verbally_threatened",
#   "child_prot_incidents.verbally_threatened",
#   "adult_prot_incidents.assaulted_without_weapon",
#   "child_prot_incidents.assaulted_without_weapon",
#   "adult_prot_incidents.hindered_leave_district",
#   "child_prot_incidents.hindered_leave_district"
#   )

data$severe_prot_incidents <- comp_score(data, severe_prot_incidents_vars)
# data$less_severe_prot_incidents <- comp_score(data, less_severe_prot_incidents_vars)

# protection concerns

severe_prot_concerns_vars <- c(
  "prot_concerns.violence_maiming",
  "prot_concerns.abduction",
  "prot_concerns.explosive_hazards",
  "prot_concerns.psych_wellbeing",
  # added from less_severe_prot_concern
  "prot_concerns.violence_injuries",
  "prot_concerns.early_marriage",
  "prot_concerns.destruction_property",
  "prot_concerns.theft"
  )

# less_severe_prot_concerns_vars <- c(
#   "prot_concerns.violence_injuries",
#   "prot_concerns.early_marriage",
#   "prot_concerns.destruction_property",
#   "prot_concerns.theft"
#   )

data$severe_prot_concerns <- comp_score(data, severe_prot_concerns_vars)
# data$less_severe_prot_concerns <- comp_score(data, less_severe_prot_concerns_vars)

# explosive hazards

severe_explosive_hazards_vars <- c(
  "explosive_impact.injury_death", 
  "explosive_impact.access_services",
  "explosive_impact.relocation", 
  "explosive_impact.livelihoods_impact", 
  "explosive_impact.psych_impact"
  )
less_severe_explosive_hazards_vars <- c(
  "explosive_impact.restrict_recreation"
  )


data$severe_explosive_hazards <- comp_score(data, severe_explosive_hazards_vars)
data$less_severe_explosive_hazards <- comp_score(data, less_severe_explosive_hazards_vars)


# tazkira

tazkira_total_vars <- c(
  "adult_tazkira", 
  "child_tazkira")
data$tazkira_total <- comp_score(data, tazkira_total_vars)

children_working_yes_no_2 = case_when(
  data$children_working == 0 ~ "0",
  data$children_working >= 1 ~ "1 or more",
  TRUE ~ NA_character_
)
# Protection Severity Score

## Weights
data <- data %>% 
  mutate(
    prot_incident_class = case_when(
      severe_prot_incidents >= 1 ~ 3,
      # severe_prot_incidents == 0 & data$less_severe_prot_incidents >= 1 ~ 2,
      TRUE ~ 0),
    # violence targeting women, girls, boys
    sgbv_incidents_class = case_when(
      other_incidents.sgbv == 1 | other_concerns.sgbv == 1 ~ 2,
      TRUE ~ 0
    ),
    # children working unsafe conditions
    children_work_safety_class = case_when(
      children_working_yes_no_2 =='1 or more' ~ 1,
      TRUE ~ 0
    ),
    prot_concerns_class = case_when(
      severe_prot_concerns >= 1 ~ 3,
      # severe_prot_concerns == 0 & data$less_severe_prot_concerns >= 1 ~ 2,
      TRUE ~ 0
    ),
    # hh members injured conflict or nat disaster
    injuries_class = case_when(
      adult_injuries_cause %in% c('conflict', 'natural_disaster') |
      child_injuries_cause %in% c('conflict', 'natural_disaster') ~ 3,
      TRUE ~ 0
    ),
    prot_explosive_hazards_class = case_when(
      severe_explosive_hazards >= 1 ~ 3,
      severe_explosive_hazards == 0 & less_severe_explosive_hazards >=1 ~ 2,
      TRUE ~ 0
    ),
    tazkira_class = case_when(
      tazkira_total == 0 ~ 2,
      tazkira_total > 0 & tazkira_total < hh_size ~ 1
      )
    )


# Score

prot_score_vars <- c(
  "prot_incident_class",
  "sgbv_incidents_class",
  "children_work_safety_class",
  "prot_concerns_class",
  "injuries_class",
  "prot_explosive_hazards_class",
  "tazkira_class")

data$prot_score <- comp_score(data, prot_score_vars)

data <- data %>% 
  mutate(
    prot_severity = case_when(
         prot_score <= 2  ~ 1,
         prot_score <= 5  ~ 2,
         prot_score <= 8  ~ 3,
         prot_score <= 18 ~ 4
         ), 
    prot_sev_high = case_when(
      prot_severity >= 3 ~ 1,
      TRUE ~ 0
      )
  )


################## protection new indicator 1 ######################


prot_all_indictors <-  c(
  "adult_prot_incidents.verbally_threatened",
  "adult_prot_incidents.assaulted_without_weapon",
  "adult_prot_incidents.assaulted_with_weapon",
  "adult_prot_incidents.hindered_leave_settlement",
  "adult_prot_incidents.hindered_leave_district",
  "adult_prot_incidents.forced_work",
  "adult_prot_incidents.forcibly_detained",
  "child_prot_incidents.verbally_threatened",
  "child_prot_incidents.assaulted_without_weapon",
  "child_prot_incidents.assaulted_with_weapon",
  "child_prot_incidents.hindered_leave_settlement",
  "child_prot_incidents.hindered_leave_district",
  "child_prot_incidents.forced_work",
  "child_prot_incidents.forcibly_detained",
  "other_incidents.sgbv",
  "other_incidents.other",
  "prot_concerns.violence_maiming",
  "prot_concerns.violence_injuries",
  "prot_concerns.psych_wellbeing",
  "prot_concerns.abduction",
  "prot_concerns.theft",
  "prot_concerns.explosive_hazards",
  "prot_concerns.destruction_property",
  "prot_concerns.early_marriage",
  "prot_concerns.other",
  "other_concerns.sgbv",
  "other_concerns.other"
  
)
data$prot_all_indictors_score <- comp_score(data, prot_all_indictors)

data <- data %>% 
  mutate(
  prot_new_indicator_1 = case_when(
    prot_all_indictors_score >= 1 ~ ">=1",
    prot_all_indictors_score == 0 ~ "0",
    TRUE ~ NA_character_
  )
)


################## protection new indicator 2 ######################

data <- data %>% 
  mutate( displ_explosive_presence_na_to_0 = case_when(
    displ_explosive_presence == "both" ~ 1,
    displ_explosive_presence == "current" ~ 1,
    displ_explosive_presence == "previous" ~ 1,
    displ_explosive_presence == "no" ~ 0,
    TRUE ~ 0
  )
  )


prot_all_indictors_2 <-  c(
  "adult_prot_incidents.verbally_threatened",
  "adult_prot_incidents.assaulted_without_weapon",
  "adult_prot_incidents.assaulted_with_weapon",
  "adult_prot_incidents.hindered_leave_settlement",
  "adult_prot_incidents.hindered_leave_district",
  "adult_prot_incidents.forced_work",
  "adult_prot_incidents.forcibly_detained",
  "child_prot_incidents.verbally_threatened",
  "child_prot_incidents.assaulted_without_weapon",
  "child_prot_incidents.assaulted_with_weapon",
  "child_prot_incidents.hindered_leave_settlement",
  "child_prot_incidents.hindered_leave_district",
  "child_prot_incidents.forced_work",
  "child_prot_incidents.forcibly_detained",
  "other_incidents.sgbv",
  "other_incidents.other",
  "prot_concerns.violence_maiming",
  "prot_concerns.violence_injuries",
  "prot_concerns.psych_wellbeing",
  "prot_concerns.abduction",
  "prot_concerns.theft",
  "prot_concerns.explosive_hazards",
  "prot_concerns.destruction_property",
  "prot_concerns.early_marriage",
  "prot_concerns.other",
  "other_concerns.sgbv",
  "other_concerns.other",
  "displ_explosive_presence_na_to_0"
  
)
data$prot_all_indictors_score_2 <- comp_score(data, prot_all_indictors_2)

data <- data %>% 
  mutate(
    prot_new_indicator_2 = case_when(
      prot_all_indictors_score_2 >= 1 ~ ">=1",
      prot_all_indictors_score_2 == 0 ~ "0",
      TRUE ~ NA_character_
    )
  )

################## protection new indicator 3 ######################

data <- data %>% 
  mutate( nondispl_explosive_presence_na_to_0 = case_when(
    nondispl_explosive_presence == "yes" ~ 1,
    nondispl_explosive_presence == "no" ~ 0,
    TRUE ~ 0
  )
)

prot_all_indictors_3 <-  c(
  "adult_prot_incidents.verbally_threatened",
  "adult_prot_incidents.assaulted_without_weapon",
  "adult_prot_incidents.assaulted_with_weapon",
  "adult_prot_incidents.hindered_leave_settlement",
  "adult_prot_incidents.hindered_leave_district",
  "adult_prot_incidents.forced_work",
  "adult_prot_incidents.forcibly_detained",
  "child_prot_incidents.verbally_threatened",
  "child_prot_incidents.assaulted_without_weapon",
  "child_prot_incidents.assaulted_with_weapon",
  "child_prot_incidents.hindered_leave_settlement",
  "child_prot_incidents.hindered_leave_district",
  "child_prot_incidents.forced_work",
  "child_prot_incidents.forcibly_detained",
  "other_incidents.sgbv",
  "other_incidents.other",
  "prot_concerns.violence_maiming",
  "prot_concerns.violence_injuries",
  "prot_concerns.psych_wellbeing",
  "prot_concerns.abduction",
  "prot_concerns.theft",
  "prot_concerns.explosive_hazards",
  "prot_concerns.destruction_property",
  "prot_concerns.early_marriage",
  "prot_concerns.other",
  "other_concerns.sgbv",
  "other_concerns.other",
  "displ_explosive_presence_na_to_0",
  "nondispl_explosive_presence_na_to_0"
  
)
data$prot_all_indictors_score_3 <- comp_score(data, prot_all_indictors_3)

data <- data %>% 
  mutate(
    prot_new_indicator_3 = case_when(
      prot_all_indictors_score_3 >= 1 ~ ">=1",
      prot_all_indictors_score_3 == 0 ~ "0",
      TRUE ~ NA_character_
    )
  )

################## protection new indicator 4 ######################

data <- data %>% 
  mutate( 
      lcsi_category_class2 = case_when(
        lcsi_category == "food_secure" | lcsi_category == "marginally_insecure" ~ 0,
        lcsi_category == "moderately_insecure" | lcsi_category == "severely_insecure" ~ 1,
        TRUE ~ 0
    )
  )

prot_all_indictors_4 <-  c(
  "adult_prot_incidents.verbally_threatened",
  "adult_prot_incidents.assaulted_without_weapon",
  "adult_prot_incidents.assaulted_with_weapon",
  "adult_prot_incidents.hindered_leave_settlement",
  "adult_prot_incidents.hindered_leave_district",
  "adult_prot_incidents.forced_work",
  "adult_prot_incidents.forcibly_detained",
  "child_prot_incidents.verbally_threatened",
  "child_prot_incidents.assaulted_without_weapon",
  "child_prot_incidents.assaulted_with_weapon",
  "child_prot_incidents.hindered_leave_settlement",
  "child_prot_incidents.hindered_leave_district",
  "child_prot_incidents.forced_work",
  "child_prot_incidents.forcibly_detained",
  "other_incidents.sgbv",
  "other_incidents.other",
  "prot_concerns.violence_maiming",
  "prot_concerns.violence_injuries",
  "prot_concerns.psych_wellbeing",
  "prot_concerns.abduction",
  "prot_concerns.theft",
  "prot_concerns.explosive_hazards",
  "prot_concerns.destruction_property",
  "prot_concerns.early_marriage",
  "prot_concerns.other",
  "other_concerns.sgbv",
  "other_concerns.other",
  "displ_explosive_presence_na_to_0",
  "nondispl_explosive_presence_na_to_0",
  "lcsi_category_class2"
  
)
data$prot_all_indictors_score_4 <- comp_score(data, prot_all_indictors_4)

data <- data %>% 
  mutate(
    prot_new_indicator_4 = case_when(
      prot_all_indictors_score_4 >= 1 ~ ">=1",
      prot_all_indictors_score_4 == 0 ~ "0",
      TRUE ~ NA_character_
    )
  )

#################################################################

################## protection new indicator 5 ######################




prot_all_indictors_5 <-  c(
  "adult_prot_incidents.verbally_threatened",
  "adult_prot_incidents.assaulted_without_weapon",
  "adult_prot_incidents.assaulted_with_weapon",
  "adult_prot_incidents.hindered_leave_settlement",
  "adult_prot_incidents.hindered_leave_district",
  "adult_prot_incidents.forced_work",
  "adult_prot_incidents.forcibly_detained",
  "child_prot_incidents.verbally_threatened",
  "child_prot_incidents.assaulted_without_weapon",
  "child_prot_incidents.assaulted_with_weapon",
  "child_prot_incidents.hindered_leave_settlement",
  "child_prot_incidents.hindered_leave_district",
  "child_prot_incidents.forced_work",
  "child_prot_incidents.forcibly_detained",
  "other_incidents.sgbv",
  "other_incidents.other",
  "prot_concerns.violence_maiming",
  "prot_concerns.violence_injuries",
  "prot_concerns.psych_wellbeing",
  "prot_concerns.abduction",
  "prot_concerns.theft",
  "prot_concerns.explosive_hazards",
  "prot_concerns.destruction_property",
  "prot_concerns.early_marriage",
  "prot_concerns.other",
  "other_concerns.sgbv",
  "other_concerns.other",
  "displ_explosive_presence_na_to_0",
  "nondispl_explosive_presence_na_to_0",
  "lcsi_category_class2",
  "children_work_safety_class"
  
)
data$prot_all_indictors_score_5 <- comp_score(data, prot_all_indictors_5)

data <- data %>% 
  mutate(
    prot_new_indicator_5 = case_when(
      prot_all_indictors_score_5 >= 1 ~ ">=1",
      prot_all_indictors_score_5 == 0 ~ "0",
      TRUE ~ NA_character_
    )
  )

################## protection new indicator 6 ######################

data <- data %>% 
  mutate(
    other_impact_class = case_when(
    other_impact.injury_death == 1 | other_impact.new_mines == 1  ~ 1,
    TRUE ~ 0
    )
  )

prot_all_indictors_6 <-  c(
  "adult_prot_incidents.verbally_threatened",
  "adult_prot_incidents.assaulted_without_weapon",
  "adult_prot_incidents.assaulted_with_weapon",
  "adult_prot_incidents.hindered_leave_settlement",
  "adult_prot_incidents.hindered_leave_district",
  "adult_prot_incidents.forced_work",
  "adult_prot_incidents.forcibly_detained",
  "child_prot_incidents.verbally_threatened",
  "child_prot_incidents.assaulted_without_weapon",
  "child_prot_incidents.assaulted_with_weapon",
  "child_prot_incidents.hindered_leave_settlement",
  "child_prot_incidents.hindered_leave_district",
  "child_prot_incidents.forced_work",
  "child_prot_incidents.forcibly_detained",
  "other_incidents.sgbv",
  "other_incidents.other",
  "prot_concerns.violence_maiming",
  "prot_concerns.violence_injuries",
  "prot_concerns.psych_wellbeing",
  "prot_concerns.abduction",
  "prot_concerns.theft",
  "prot_concerns.explosive_hazards",
  "prot_concerns.destruction_property",
  "prot_concerns.early_marriage",
  "prot_concerns.other",
  "other_concerns.sgbv",
  "other_concerns.other",
  "displ_explosive_presence_na_to_0",
  "nondispl_explosive_presence_na_to_0",
  "lcsi_category_class2",
  "other_impact_class"
  
)
data$prot_all_indictors_score_6 <- comp_score(data, prot_all_indictors_6)

data <- data %>% 
  mutate(
    prot_new_indicator_6 = case_when(
      prot_all_indictors_score_6 >= 1 ~ ">=1",
      prot_all_indictors_score_6 == 0 ~ "0",
      TRUE ~ NA_character_
    )
  )



###################################################end
### ESNFI ####

# shelter type
data$shelter_class<-ifelse(data$shelter == 'open_space',3,ifelse(data$shelter == 'tent' | data$shelter == 'makeshift_shelter' | data$shelter == 'collective_centre' | data$shelter == 'transitional',2,0))

# shelter damage
data$shelter_damage_class<-ifelse(data$shelter_damage_extent== 'fully_destroyed' & data$shelter_damage_repair == 'no',3,
                                  ifelse(data$shelter_damage_extent== 'significant_damage' & data$shelter_damage_repair == 'no',2,
                                         ifelse(data$shelter_damage_extent== 'partial_damage' & data$shelter_damage_repair == 'no',1,0)))

data$shelter_damage_class[is.na(data$shelter_damage_class)] <- 0

# TENENCY AGREEMENT
data$tenancy_class<-ifelse(data$tenancy == 'unofficial',3,ifelse(data$tenancy == 'own_home_without_doc' | data$tenancy == 'rental_verbal' | data$shelter_hosted == 'yes',2,0))

data$tenancy_class[is.na(data$tenancy_class)] <- 0

# blankets
data$blankets_class<-ifelse(data$blankets_number > data$hh_size,3,0)
data$blankets_class[is.na(data$blankets_class)] <- 0

# basic needs
data$sleeping_mats <- car::recode(data$sleeping_mats, " 'yes' = 1; 'no' = 0")
data$tarpaulin <- car::recode(data$tarpaulin, " 'yes' = 1; 'no' = 0")
data$cooking_pots <- car::recode(data$cooking_pots, " 'yes' = 1; 'no' = 0")
data$stainless_steel <- car::recode(data$stainless_steel, " 'yes' = 1; 'no' = 0")
data$water_storage <- car::recode(data$water_storage, " 'yes' = 1; 'no' = 0")
data$hygiene_sanitation <- car::recode(data$hygiene_sanitation, " 'yes' = 1; 'no' = 0")

data$basic_needs_total<-coerc(data[["sleeping_mats"]])+coerc(data[["tarpaulin"]])+coerc(data[["cooking_pots"]])+coerc(data[["stainless_steel"]])+coerc(data[["water_storage"]])+coerc(data[["hygiene_sanitation"]])

data$basic_needs_score<-car::recode(data$basic_needs_total,
                                    "0:2=3;
                                    3:5=2;
                                    6=0")  

# ESNFI Severity Score
data$esnfi_score<-coerc(data[["shelter_class"]])+coerc(data[["shelter_damage_class"]])+coerc(data[["tenancy_class"]])+coerc(data[["blankets_class"]])+coerc(data[["basic_needs_score"]])

data$esnfi_severity<-car::recode(data$esnfi_score,
                                 "0:2='1';
                                 3:6='2';
                                 7:9='3';
                                 10:16='4'") 

data$esnfi_sev_high<-ifelse(data$esnfi_severity==3|data$esnfi_severity==4,1,0)

###################################################end
### <3 <3 <3 <3 <3 ESNFI 4 ARI <3 <3 <3 <3 <3 ####

# shelter type
data$shelter_class_4_ari<-case_when(data$shelter == 'open_space'| data$shelter == 'tent' | data$shelter == 'makeshift_shelter'| data$shelter == 'collective_centre' ~3, data$shelter == 'transitional'~2,
                              data$shelter=='permanent' & (data$shelter_hosted_why =='cash_rent'| data$shelter_hosted_why =='trans_shelter_host_family'| data$shelter_hosted_why =='materials_tools_extend') ~2, TRUE~  0)

# shelter damage
data$shelter_damage_class_4_ari<-ifelse(data$shelter_damage_extent== 'fully_destroyed' & data$shelter_damage_repair == 'no',3,
                                  ifelse(data$shelter_damage_extent== 'significant_damage' & data$shelter_damage_repair == 'no',2,
                                         ifelse(data$shelter_damage_extent== 'partial_damage' & data$shelter_damage_repair == 'no',1,0)))

data$shelter_damage_class_4_ari[is.na(data$shelter_damage_class_4_ari)] <- 0

# TENENCY AGREEMENT
data$tenancy_class_4_ari<-ifelse(data$tenancy == 'unofficial',3,ifelse(data$tenancy == 'own_home_without_doc' | data$tenancy == 'rental_verbal' | data$shelter_hosted == 'yes',2,0))

data$tenancy_class_4_ari[is.na(data$tenancy_class_4_ari)] <- 0


# ESNFI Severity Score
data$esnfi_score_4_ari<-coerc(data[["shelter_class_4_ari"]])+coerc(data[["shelter_damage_class_4_ari"]])+coerc(data[["tenancy_class_4_ari"]])

data$esnfi_severity_4_ari<-car::recode(data$esnfi_score_4_ari,
                                 "0:2='1';
                                 3:4='2';
                                 5:6='3';
                                 7:10='4'") 

data$esnfi_sev_high_4_ari<-ifelse(data$esnfi_severity_4_ari==3|data$esnfi_severity_4_ari==4,1,0)

#################################################################

### WASH ####

# water source #
data$water_source_class<-car::recode(data$water_source,
                                "'surface_water'=3;
                                'water_trucking'=2;
                                'spring_unprotected'=2;
                                'spring_protected'=0;
                                'handpump_private'=0;
                                'handpump_public'=0;
                                'piped_public'=0;
                                'other'=0")

# water barriers
data$water_barriers_class<-ifelse(data$water_sufficiency== 'insufficient' &
                                    (data$water_barriers== 'too_far' |
                                       data$water_barriers== 'high_risk' | 
                                       data$water_barriers== 'social_restrictions'),
                                  3,ifelse(data$water_sufficiency== 'insufficient',2,
                                           ifelse(data$water_sufficiency== 'barely_sufficient',1,0)))

data$water_barriers_class[is.na(data$water_barriers)] <- 0

# soap  
data$soap_class<-ifelse(data$soap == 'yes_didnt_see' | data$soap == 'no', 1,0)

# latrines #
data$latrine_class<-ifelse(data$latrine == 'open' | data$latrine == 'public_latrine', 3, 
                           ifelse(data$latrine == 'pit_latrine_uncovered',2,0))

# primary waste dispopsal #
data$waste_disposal_class<-ifelse(data$waste_disposal == 'open_space' | data$waste_disposal == 'burning', 2,0)

#distance to primary water source
data$water_distance_class<-ifelse(data$water_distance == 'over_1km'| data$water_distance == '500m_to_1km',3,0)

# WASH Severity Score
data$wash_score<-coerc(data[["water_source_class"]])+coerc(data[["water_barriers_class"]])+coerc(data[["soap_class"]])+coerc(data[["latrine_class"]])+coerc(data[["waste_disposal_class"]])+coerc(data[["water_distance_class"]])

data$wash_severity<-car::recode(data$wash_score,
                           "0:2='1';
                           3:5='2';
                           6:8='3';
                           9:16='4'")      

data$wash_sev_high<-ifelse(data$wash_severity==3|data$wash_severity==4,1,0)

#################################################################
### Nutrition ####

muac_presence_analysis<-overall_muac_data %>% 
  group_by(`_submission__uuid`) %>% 
  filter(person_muac>=1) %>% 
  summarize(number_muac_person=sum(person_muac),
            number_muac_mod_mal=sum(moderate_malnutrition),
            number_muac_sev_mal=sum(severe_malnutrition),
            number_muac_above_125 = sum(muac_measurement>=125, na.rm = T),
            min_muac=min(muac_measurement),
            ruft_reception_num = sum(rutf_reception== "yes"),
            ruft_reception = sum(rutf_reception== "yes")>=1)
# Malnutrition present = 1, not present = 0

muac_presence_analysis$malnutrition_present<-ifelse(muac_presence_analysis$number_muac_mod_mal>=1 | muac_presence_analysis$number_muac_sev_mal>=1,1,0) 

# join with parent table  
data<-full_join(data, muac_presence_analysis, by = c("uuid"="_submission__uuid"))


# reported malnourishment (mod & sev muac)
data$muac_score<-ifelse(data$number_muac_sev_mal>1,7,ifelse(data$number_muac_sev_mal==1,6,ifelse(data$number_muac_sev_mal==0 & data$number_muac_mod_mal>1,4,ifelse(data$number_muac_sev_mal==0 & data$number_muac_mod_mal==1,3,0))))

# dietary diversity --- 
# therefore nutrition compotite indicator will exclude hhs with children aged 2-5, since this they are not asked this question ###
data$dietary_div_count<-coerc(data[["minimum_dietary_diversity.staples"]])+coerc(data[["minimum_dietary_diversity.legumes"]])+coerc(data[["minimum_dietary_diversity.dairy"]])+coerc(data[["minimum_dietary_diversity.meat"]])+coerc(data[["minimum_dietary_diversity.eggs"]])+coerc(data[["minimum_dietary_diversity.vitamin_a_veg"]])+coerc(data[["minimum_dietary_diversity.other_veg"]])

data$dietary_div_score<-ifelse(data$dietary_div_count==0,4,ifelse(data$dietary_div_count==1,3,ifelse(data$dietary_div_count==2,2,ifelse(data$dietary_div_count==3,1,0))))
data$dietary_div_score[is.na(data$dietary_div_score)] <- 0

# Nutrition Severity Score
data$nut_score_hh_w_muac<-coerc(data[["muac_score"]])+coerc(data[["dietary_div_score"]])
data$nut_score<-data$nut_score_hh_w_muac
data$nut_score[is.na(data$nut_score)] <- 0

data$nut_severity<-car::recode(data$nut_score,
                          "0:2='1';
                          3:5='2';
                          6:8='3';
                          9:16='4'")  



# data$nut_sev_high<-ifelse(data$nut_severity==3|data$nut_severity==4,1,0)
data$nut_sev_high<-ifelse(data$nut_severity==3|data$nut_severity==4 | data$nut_severity==2   ,1,0)

#################################################################

### Education EiE ####

education_analysis<-overall_hh_roster %>% 
  filter(!is.na(current_year_enrolled))

education_analysis$enrolled_and_attending<-ifelse(education_analysis$current_year_enrolled=='no',0,
                                                  ifelse(education_analysis$current_year_enrolled=='yes' & education_analysis$current_year_attending=='no',0,1))



education_analysis$total_schoolage_child<-1  

#removal from school due to shock
education_analysis$shock_presence<-coerc(education_analysis[["edu_removal_shock.displacement"]])+coerc(education_analysis[["edu_removal_shock.conflict"]])+coerc(education_analysis[["edu_removal_shock.natural_disaster"]])
education_analysis$shock_presence[is.na(education_analysis$shock_presence)] <- 0

################## not part of composite #################################################
education_analysis$enrolled_1 <- if_else(education_analysis$current_year_enrolled=='no',0,1)
education_analysis$attending_1 <- if_else(education_analysis$current_year_attending=='no',0,1)


education_analysis <- education_analysis %>% 
  mutate(
    attending_male = case_when(
      current_year_attending == "yes" & hh_member_sex == "male" ~ 1, 
      TRUE ~ 0 
    ),
    attending_female = case_when(
      current_year_attending == "yes" & hh_member_sex == "female" ~ 1, 
      TRUE ~ 0 
    ),
    enrolled_male = case_when(
      current_year_enrolled == "yes" & hh_member_sex == "male" ~ 1, 
      TRUE ~ 0 
    ),
    enrolled_female = case_when(
      current_year_enrolled == "yes" & hh_member_sex == "female" ~ 1, 
      TRUE ~ 0 
    ),
    shock_presence_male = case_when(
      shock_presence > 0  & hh_member_sex == "male" ~ 1, 
      TRUE ~ 0
    ),
    shock_presence_female = case_when(
      shock_presence > 0  & hh_member_sex == "female" ~ 1, 
      TRUE ~ 0
    )
  )

####################################################################################


# group dataset into hh
education_analysis_hh<-education_analysis %>% 
  group_by(`_submission__uuid`) %>% 
  summarize(count_school_child=sum(total_schoolage_child),
            count_enrolled_attending=sum(enrolled_and_attending),
            count_current_enrolled = sum(enrolled_1, na.rm = T),
            count_current_enrolled_male = sum(enrolled_male, na.rm = T),
            count_current_enrolled_female = sum(enrolled_female, na.rm = T),
            count_current_attending = sum(attending_1, na.rm = T),
            count_current_attending_male = sum(attending_male, na.rm = T),
            count_current_attending_female = sum(attending_female, na.rm = T),
            count_shock=sum(shock_presence), 
            count_shock_male = sum(shock_presence_male, na.rm = T),
            count_shock_female = sum(shock_presence_female, na.rm = T)
            )

# shock weight
education_analysis_hh$shock_class<-ifelse(education_analysis_hh$count_shock >= 1, 5,0)


# percent children enrolled or attending
education_analysis_hh$percent_enrolled= coerc(education_analysis_hh[["count_enrolled_attending"]])/coerc(education_analysis_hh[["count_school_child"]])

education_analysis_hh$enroll_perc_class<-car::recode(education_analysis_hh$percent_enrolled,
                                                "0:0.249=1;
                                                0.25:0.499=2;
                                                0.5:0.749=3;
                                                0.75:1=4")   

# greater than 3 children not attending

education_analysis_hh$count_not_enrolled<-coerc(education_analysis_hh[["count_school_child"]])-coerc(education_analysis_hh[["count_enrolled_attending"]])

education_analysis_hh$count_not_enrolled_class<-ifelse(education_analysis_hh$count_not_enrolled>=3,3,0)


# join with parent table  
data<-full_join(data, education_analysis_hh,by = c("uuid"="_submission__uuid"))

# reasons not attending
data$severe_not_attending<-coerc(data[["boy_unattendance_reason.insecurity"]])+coerc(data[["boy_unattendance_reason.child_works_instead"]])+coerc(data[["girl_unattendance_reason.insecurity"]])+coerc(data[["girl_unattendance_reason.child_works_instead"]])
data$severe_not_attending[is.na(data$severe_not_attending)] <- 0

data$less_severe_not_attending<-coerc(data[["boy_unattendance_reason.lack_facilities"]])+coerc(data[["boy_unattendance_reason.lack_documentation"]])+coerc(data[["boy_unattendance_reason.too_expensive"]])+coerc(data[["girl_unattendance_reason.lack_facilities"]])+coerc(data[["girl_unattendance_reason.lack_documentation"]])+coerc(data[["girl_unattendance_reason.too_expensive"]])
data$less_severe_not_attending[is.na(data$less_severe_not_attending)] <- 0

data$not_attending_class<-ifelse(data$severe_not_attending >= 1,3, ifelse(data$severe_not_attending==0 & data$less_severe_not_attending >=1,2,0))
data$not_attending_class[is.na(data$not_attending_class)] <- 0

# Education Severity Score
data$edu_score_hh_w_schoolage<-coerc(data[["enroll_perc_class"]])+coerc(data[["shock_class"]])+coerc(data[["count_not_enrolled_class"]])+coerc(data[["not_attending_class"]])
data$edu_score<-data$edu_score_hh_w_schoolage
data$edu_score[is.na(data$edu_score)] <- 0

data$edu_severity<-car::recode(data$edu_score,
                          "0:2='1';
                          3:5='2';
                          6:8='3';
                          9:16='4'")   

data$edu_sev_high<-ifelse(data$edu_severity==3|data$edu_severity==4,1,0)

#################################################################
### Health ####

#deaths under 5 years age
overall_death_roster$deaths_under5<-ifelse(overall_death_roster$hh_died_age<5,1,0)

# deaths >= 5
overall_death_roster$deaths_over5<-ifelse(overall_death_roster$hh_died_age>=5,1,0)


# group by hh
health_analysis<-overall_death_roster %>%
  group_by(`_submission__uuid`) %>%
  summarize(number_death_under5=sum(deaths_under5),
            hh_member_died = sum(hh_member_died),
            number_death_over5=sum(deaths_over5))

# join with parent dataset
data<-full_join(data, health_analysis,by = c("uuid"="_submission__uuid"))
data$number_death_under5[is.na(data$number_death_under5)] <- 0
# #deaths under 5 yrs age weight
# data$number_death_under5_class<-ifelse(data$number_death_under5 >= 1, 3,0)
# data$number_death_under5_class[is.na(data$number_death_under5_class)] <- 0
# 
# # deaths >= 5 weight
# data$number_death_over5_class<-ifelse(data$number_death_over5 >= 1, 2,0)
# data$number_death_over5_class[is.na(data$number_death_over5_class)] <- 0

# health facility barriers
data$health_barriers_total<-coerc(data[["health_facility_barriers.unsafe"]])+coerc(data[["health_facility_barriers.cost_services"]])+coerc(data[["health_facility_barriers.cost_medicines"]])+coerc(data[["health_facility_barriers.too_far"]])+coerc(data[["health_facility_barriers.documentation_problems"]])+coerc(data[["health_facility_barriers.insufficient_female_staff"]])+coerc(data[["health_facility_barriers.treatment_refused"]])+coerc(data[["health_facility_barriers.other"]])
data$health_barriers_total[is.na(data$health_barriers_total)] <- 0

# data$health_facility_barriers_class<-ifelse(data$health_facility_access == 'no' & data$health_barriers_total>1,3,ifelse(data$health_facility_access == 'no' & data$health_barriers_total==1,2,0))
data$health_facility_barriers_class<-ifelse(data$health_facility_access == 'no' ,3,0)

# health facility distance
data$health_facility_dist_class<-ifelse(data$health_facility_distance == 'none' | data$health_facility_distance=='more_10km',3,ifelse(data$health_facility_distance=='6_10km',2,0))

# health facilities affected
data$health_facility_affected_class<-ifelse(data$health_facility_affected_how == 'forcibly_closed'|data$health_facility_affected_how == 'damaged_conflict'|data$health_facility_affected_how == 'damaged_natural_disasters',3, ifelse(data$health_facility_affected_how=='lack_staff'|data$health_facility_affected_how=='lack_medicine',2,0))
data$health_facility_affected_class[is.na(data$health_facility_affected_class)] <- 0

# health selected as priority need
data$health_priority_need_class<-ifelse(data$priority_needs.healthcare == 1, 3,0)

# behaviour changes as result of conflict
data$behavior_change_cause_class<-case_when(data$adult_behavior_change == 'yes'& data$behavior_change_cause=='yes'~ 3,
                                            data$child_behavior_change == 'yes'& data$behavior_change_cause=='yes'~ 3, TRUE~ 0)
data$behavior_change_cause_class[is.na(data$behavior_change_cause_class)] <- 0

# birth location
# data$birth_location_class<-ifelse(data$birth_location == 'home'|data$birth_location == 'midwife_home'|data$birth_location == 'outside'|data$birth_location == 'other',1,0)
# data$birth_location_class[is.na(data$birth_location_class)] <- 0

# Health Severity Score
# data$health_score<- coerc(data[["health_facility_barriers_class"]])+coerc(data[["health_facility_dist_class"]])+coerc(data[["health_facility_affected_class"]])+coerc(data[["health_priority_need_class"]])+coerc(data[["behavior_change_cause_class"]])+coerc(data[["birth_location_class"]])
data$health_score<- coerc(data[["health_facility_barriers_class"]])+coerc(data[["health_facility_dist_class"]])+coerc(data[["health_facility_affected_class"]])+coerc(data[["health_priority_need_class"]])+coerc(data[["behavior_change_cause_class"]])

data$health_severity<-car::recode(data$health_score,
                                  "0:2='1';
                                  3:5='2';
                                  6:8='3';
                                  9:16='4'")   

data$health_sev_high<-ifelse(data$health_severity==3|data$health_severity==4,1,0)

#################################################################

# number sectoral needs ####

data$total_sectoral_needs<-coerc(data[["fsac_sev_high"]])+coerc(data[["prot_sev_high"]])+coerc(data[["esnfi_sev_high"]])+coerc(data[["wash_sev_high"]])+coerc(data[["nut_sev_high"]])+coerc(data[["edu_sev_high"]])+coerc(data[["health_sev_high"]])


#################################################################

### LSCI - coping strategies ####

# coping severity
data$lcsi_severity<-car::recode(data$lcsi_category,
                           "'food_secure'='minimal';
                           'marginally_insecure'='stress';
                           'moderately_insecure'='severe';
                           'severely_insecure'='extreme'")   



## Indicators ####


### Numerators
## Some numerators combine variables calcualte those here
data$edu_age_boys_girls_num <-  comp_score(data, c("boys_ed","girls_ed"))

food_water_rent_vars <- c(
  "food_exp",
  "water_expt",
  "rent_exp"
)
data$food_water_rent_num <- comp_score(data, food_water_rent_vars)


all_expenses_vars <- c(
  "food_exp",
  "water_expt",
  "rent_exp",
  "fuel_exp",
  "debt_exp")
data$all_expenses <- comp_score(data, all_expenses_vars)


min_die_vars <- c(
    "minimum_dietary_diversity.staples",
    "minimum_dietary_diversity.legumes",
    "minimum_dietary_diversity.dairy",
    "minimum_dietary_diversity.meat",
    "minimum_dietary_diversity.eggs",
    "minimum_dietary_diversity.vitamin_a_veg",
    "minimum_dietary_diversity.other_veg")

data$min_die_num <- comp_score(data, min_die_vars)

priority_nfi_vars <- c(
  "sleeping_mats",
  "tarpaulin",
  "cooking_pots",
  "stainless_steel",
  "water_storage",
  "hygiene_sanitation"
)
  
data$priority_nfi_num <- comp_score(data, priority_nfi_vars)

child_vars <- c(
  "males_0_2_total",
  "males_3_5_total",
  "females_0_2_total",
  "females_3_5_total")
data$children_under5 <- comp_score(data, child_vars)

comp_ind_vars <- c(
  "prot_sev_high",
  "fsac_sev_high",
  "esnfi_sev_high",
  "wash_sev_high",
  "edu_sev_high",
  "health_sev_high"
)
data$comp_ind_sev <- comp_score(data, comp_ind_vars)


comp_ind_vars_nut <- c(
  "prot_sev_high",
  "fsac_sev_high",
  "esnfi_sev_high",
  "wash_sev_high",
  "edu_sev_high",
  "health_sev_high",
  "nut_sev_high"
)
data$comp_ind_sev_nut <- comp_score(data, comp_ind_vars_nut)


## Age categories hh

data <- data %>% 
  mutate(
    age_0_4_hh = case_when(
      hoh_age <=4 ~ 1,
      TRUE ~ 0
    ),
    age_0_17_hh = case_when(
      hoh_age <=17 ~ 1,
      TRUE ~ 0
    ) ,
    age_0_14_hh = case_when(
      hoh_age <=14 ~ 1,
      TRUE ~ 0
    ) ,
    age_10_17_hh = case_when(
      hoh_age >= 10 & hoh_age <=17 ~ 1,
      TRUE ~ 0
    ) ,
    age_15_64_hh = case_when(
      hoh_age >= 14 & hoh_age <=64 ~ 1,
      TRUE ~ 0
    )  ,
    age_18_59_hh = case_when(
      hoh_age >= 18 & hoh_age <=59 ~ 1,
      TRUE ~ 0
    ) ,
    age_18_64_hh = case_when(
      hoh_age >= 18 & hoh_age <=64 ~ 1,
      TRUE ~ 0
    ) ,
    age_60_and_more_hh = case_when(
      hoh_age >= 60 ~ 1,
      TRUE ~ 0
    ) ,
    age_65_hh = case_when(
      hoh_age >= 65 ~ 1,
      TRUE ~ 0
    ) ,
    testt = case_when(
      hoh_age < 120 ~ 1, 
      TRUE ~ 0
    )
  )

## Age categories roster

hh_group <- overall_hh_roster %>% 
  mutate(
    age_0_4 =  hh_member_age <=4,
    age_0_17 =  hh_member_age <=17,
    age_0_14 =  hh_member_age <=14,
    age_10_17 =  hh_member_age >= 10 & hh_member_age <=17,
    age_15_64 =  hh_member_age >= 14 & hh_member_age <=64,
    age_18_59 = hh_member_age >= 18 & hh_member_age <=59,
    age_18_64 =  hh_member_age >= 18 & hh_member_age <=64,
    age_60_and_more = hh_member_age >= 60,
    age_65 =  hh_member_age >= 65
  ) %>% 
  group_by(`_submission__uuid`) %>% 
  summarise(
    age_0_4 = sum(age_0_4, na.rm = TRUE),
    age_0_17 = sum(age_0_17, na.rm = TRUE),
    age_0_14 = sum(age_0_14, na.rm = TRUE),
    age_10_17 = sum(age_10_17, na.rm = TRUE),
    age_15_64 = sum(age_15_64, na.rm = TRUE),
    age_18_59 = sum(age_18_59, na.rm = TRUE),
    age_18_64 = sum(age_18_64, na.rm = TRUE),
    age_60_and_more = sum(age_60_and_more, na.rm = T),
    age_65 = sum(age_65, na.rm = TRUE)
  )  

# Age Cat Vars
age_0_4_vars <- c(
  'age_0_4',
  'age_0_4_hh'
)
age_0_17_vars <- c(
  'age_0_17',
  'age_0_17_hh'
)

age_0_14_vars <- c(
  'age_0_14',
  'age_0_14_hh'
)

age_10_17_vars <- c(
  'age_10_17',
  'age_10_17_hh'
)

age_15_64_vars <- c(
  'age_15_64',
  'age_15_64_hh'
)

age_18_59_vars <- c(
  'age_18_59',
  'age_18_59_hh'
)

age_18_64_vars <- c(
  'age_18_64',
  'age_18_64_hh'
)

age_60_and_more_var <- c(
  'age_60_and_more',
  'age_60_and_more_hh'
)

age_65_var <- c(
  'age_65',
  'age_65_hh'
)




data <- full_join(data, hh_group,by = c("uuid"="_submission__uuid"))

# Merge Age cat hh_roster and hh data

data$age_0_4_merged <-   comp_score(data,age_0_4_vars)
data$age_0_17_merged <- comp_score(data,age_0_17_vars)
data$age_0_14_merged <- comp_score(data,age_0_14_vars)
data$age_10_17_merged <- comp_score(data,age_10_17_vars)
data$age_15_64_merged <- comp_score(data,age_15_64_vars)
data$age_18_59_merged <- comp_score(data,age_18_59_vars)
data$age_18_64_merged <- comp_score(data,age_18_64_vars)
data$age_60_and_more_merged <- comp_score(data,age_60_and_more_var)
data$age_65_merged <- comp_score(data,age_65_var)

 # Adjust displacement status as more information in other data
non_displ_data <- read.csv("input/Non_Displaced_Host_List_v2.csv",stringsAsFactors=F,na.strings = c("", "NA"))
data<-full_join(data, non_displ_data,by = c("district"="district"))
  data$final_displacement_status_non_displ<-ifelse(data$final_displacement_status=='non_displaced'|data$final_displacement_status=='host', data$non_displ_class,data$final_displacement_status)

# prev_displacement
data <- data %>% 
  mutate(
    # prev_displacement_num
    prev_displacement_num_class = case_when(
      prev_displacement_num == 2 ~ "2",
      prev_displacement_num == 3 ~ "3",
      prev_displacement_num >3 ~ "4+"
    ),
    # refugee_displace_year
    refugee_displace_year_class = case_when(
      refugee_displace_year == 0 ~ "0",
      refugee_displace_year == 1 ~ "1",
      refugee_displace_year == 2 ~ "2",
      refugee_displace_year == 3 ~ "3",
      refugee_displace_year > 3 ~ "4+"
    ),
    # cb_return_displace_year
    cb_return_displace_year_class = case_when(
      cb_return_displace_year == 0 ~ "0",
      cb_return_displace_year == 1 ~ "1",
      cb_return_displace_year == 2 ~ "2",
      cb_return_displace_year == 3 ~ "3",
      cb_return_displace_year > 3 ~ "4+"
    ),
    # cb_return_return_year
    cb_return_return_year_call = case_when(
      cb_return_return_year == 0 ~ "0",
      cb_return_return_year == 1 ~ "1",
      cb_return_return_year == 2 ~ "2",
      cb_return_return_year == 3 ~ "3",
      cb_return_return_year > 3 ~ "4+"
    ),
    # idp_displ_year
    idp_displ_year_class = case_when(
      idp_displ_year == 0 ~ "0",
      idp_displ_year == 1 ~ "1",
      idp_displ_year == 2 ~ "2",
      idp_displ_year == 3 ~ "3",
      idp_displ_year > 3 ~ "4+"
    ),
    # head of household age_group
    hoh_age_group = case_when(
      hoh_age >= 65 ~ "65+",
      hoh_age < 65 ~ "<65"
    ),
    # head of household disabled
    hoh_disabled = case_when(
      wg_walking == "yes" |  wg_selfcare == "yes" ~ "disabled",
      wg_walking == "no" |  wg_selfcare == "no" ~ "not_disabled",
      TRUE ~ NA_character_
    ),
    pregnant_member = case_when(
      pregnant > 0 ~ "at_least_one_mem_pregnant",
      pregnant == 0 ~ "no_mem_pregnent",
      TRUE ~ NA_character_
    ),
    lactating_member = case_when(
      lactating > 0 ~ "at_least_one_mem_lactating",
      lactating == 0 ~ "no_mem_lactating",
      TRUE ~ NA_character_
    ),
    pregnant_lactating_member = case_when(
      pregnant > 0 | lactating > 0 ~ "at_least_one_mem_pregnant_lactating",
      pregnant == 0 & lactating == 0 ~ "no_mem_pregnent_lactating",
      TRUE ~ NA_character_
    ),
    female_literacy_yes_no = case_when(
      female_literacy == 0 ~ "0",
      female_literacy >= 1 ~ "1 or more",
      TRUE ~ NA_character_
    ),
    male_literacy_yes_no = case_when(
      male_literacy == 0 ~ "0",
      male_literacy >= 1 ~ "1 or more",
      TRUE ~ NA_character_
    ),
    # How many adults 18+ years worked outside of the household in the last 30 days?
    adults_working_yes_no = case_when(
      adults_working == 0 ~ "0",
      adults_working >= 1 ~ "1 or more",
      TRUE ~ NA_character_
    ),
    children_working_yes_no = case_when(
      children_working == 0 ~ "0",
      children_working >= 1 ~ "1 or more",
      TRUE ~ NA_character_
    ),
    ag_income_cal = case_when(
      ag_income == 0 ~ 0,
      ag_income > 0 ~ ag_income / hh_size,
      TRUE ~ NA_real_
    ),
    livestock_income_cal = case_when(
      livestock_income == 0 ~ 0,
      livestock_income > 0 ~ livestock_income / hh_size,
      TRUE ~ NA_real_
    ),
    rent_income_cal = case_when(
      rent_income == 0 ~ 0,
      rent_income > 0 ~ rent_income / hh_size,
      TRUE ~ NA_real_
    ),
    small_business_income_cal = case_when(
      small_business_income == 0 ~ 0,
      small_business_income > 0 ~ small_business_income / hh_size,
      TRUE ~ NA_real_
    ),
    unskill_labor_income_cal = case_when(
      unskill_labor_income == 0 ~ 0,
      unskill_labor_income > 0 ~    unskill_labor_income / hh_size,
      TRUE ~ NA_real_
    ),
    skill_labor_income_cal = case_when(
      skill_labor_income == 0 ~ 0,
      skill_labor_income > 0 ~    skill_labor_income / hh_size,
      TRUE ~ NA_real_
    ),
    formal_employment_income_cal = case_when(
      formal_employment_income == 0 ~ 0,
      formal_employment_income > 0 ~    formal_employment_income / hh_size,
      TRUE ~ NA_real_
    ),
    gov_benefits_income_cal = case_when(
      gov_benefits_income == 0 ~ 0,
      gov_benefits_income > 0 ~ gov_benefits_income / hh_size,
      TRUE ~ NA_real_
    ),
    hum_assistance_income_cal = case_when(
      hum_assistance_income == 0 ~ 0,
      hum_assistance_income > 0 ~ hum_assistance_income / hh_size,
      TRUE ~ NA_real_
    ),
    remittance_income_cal = case_when(
      remittance_income == 0 ~ 0,
      remittance_income > 0 ~ remittance_income / hh_size,
      TRUE ~ NA_real_
    ),
    loans_income_cal = case_when(
      loans_income == 0 ~ 0,
      loans_income > 0 ~    loans_income / hh_size,
      TRUE ~ NA_real_
    ),
    asset_selling_income_cal = case_when(
      asset_selling_income == 0 ~ 0,
      asset_selling_income > 0 ~    asset_selling_income / hh_size,
      TRUE ~ NA_real_
    ),
    total_income_cal = case_when(
      total_income == 0 ~ 0,
      total_income > 0 ~    total_income / hh_size,
      TRUE ~ NA_real_
    ),
    # Debt level
    debt_amount_cal = case_when(
      debt_amount == 0 ~ 0,
      debt_amount > 0 ~    debt_amount / hh_size,
      TRUE ~ NA_real_),
    food_exp_cal = case_when(
      total_income == 0 ~ 0,
      total_income > 0 ~ food_exp / total_income,
      TRUE ~ NA_real_
    ),
    water_expt_cal = case_when(
      total_income == 0 ~ 0,
      total_income > 0 ~ water_expt / total_income,
      TRUE ~ NA_real_
    ),
    rent_exp_cal = case_when(
      total_income == 0 ~ 0,
      total_income > 0 ~ rent_exp / total_income,
      TRUE ~ NA_real_
    ),
    fuel_exp_cal = case_when(
      total_income == 0 ~ 0,
      total_income > 0 ~ fuel_exp / total_income,
      TRUE ~ NA_real_
    ),
    debt_exp_cal = case_when(
      total_income == 0 ~ 0,
      total_income > 0 ~ debt_exp / total_income,
      TRUE ~ NA_real_
    ),
    basic_needs_cal = case_when(
      total_income == 0 ~ 0,
      food_water_rent_num > 0 ~ food_water_rent_num / total_income,
      TRUE ~ NA_real_
    ),
    minimum_dietary_diversity_cal = case_when(
      min_die_num >= 4 ~ "4 food groups",
      min_die_num < 4 ~  "<4 food groups",
      TRUE ~ NA_character_
    ),
    rooms_hh_cal = case_when(
      rooms > 0 ~     hh_size / rooms,
      TRUE ~ 0
    ),
    blankets_people_cal = case_when(
      blankets_number == 0 ~ 0,
      blankets_number > 0 ~    blankets_number / hh_size,
      TRUE ~ NA_real_
    ),
    blankets_suff_cal = case_when(
      blankets_people_cal < 1 ~ "<1",
      blankets_people_cal >= 1 ~ "1+",
      TRUE ~ NA_character_
    ),
    priority_nfi_cal = case_when(
      priority_nfi_num <= 1 ~ "0_1",
      priority_nfi_num <= 3 ~ "2_3",
      priority_nfi_num <= 5 ~ "4_5",
      priority_nfi_num <= 6 ~ "6",
      TRUE ~ NA_character_
    ),
    imp_energy_source1_cal = case_when(
      energy_source %in% c("wood" , "animal_waste" , "paper_waste") ~ 1,
      TRUE ~ 0
    ),  
    imp_energy_source2_cal = case_when(
      energy_source %in% c("coal" , "charcoal" , "lpg" , "electricity") ~ 1,
      TRUE ~ 0
    ),  
    diarrhea_cases_cal = case_when(
      diarrhea_cases == 0 ~ 0,
      diarrhea_cases > 0 ~    diarrhea_cases / diarrhea_total,
      TRUE ~ NA_real_
    ), 
    perc_diarrhea_cases_cal = case_when(
      diarrhea_cases == 0 ~ "0",
      diarrhea_cases > 0 ~ ">=1",
      TRUE ~ NA_character_
    ),
    imp_water_source1_cal = case_when(
      water_source %in% c("handpump_private", "handpump_public",
                          "piped_public", "spring_protected") ~ 1,
      TRUE ~ 0
    ),  
    imp_water_source2_cal = case_when(
      water_source %in% c("spring_unprotected","surface_water"
                          , "water_trucking", "other") ~ 1,
      TRUE ~ 0
    ),  
    imp_san_source1_cal = case_when(
      water_source %in% c("open", "pit_latrine_uncovered", 
                          "other") ~ 1,
      TRUE ~ 0
    ),  
    imp_san_source2_cal = case_when(
      water_source %in% c("public_latrine", "pit_latrine_covered",
                          "vip_latrine", "flush_toilet_open_drain",
                          "flush_toilet_septic") ~ 1,
      TRUE ~ 0
    ),  
    comp_ind_sev_2_call = case_when(
      comp_ind_sev >= 2 ~ ">=2",
      comp_ind_sev <2 ~ "<2",
      TRUE ~ NA_character_
    ),
    comp_ind_sev_2_nut_call = case_when(
      comp_ind_sev_nut >= 2 ~ ">=2",
      comp_ind_sev_nut <2 ~ "<2",
      TRUE ~ NA_character_
    ),
    
    comp_ind_sev_3_call = case_when(
      comp_ind_sev >= 3 ~ ">=3",
      comp_ind_sev < 3 ~ "<3",
      TRUE ~ NA_character_
    ),
    dep_ratio_call =  case_when(
      age_0_4_merged == 0 & age_65_merged == 0 ~ 0,
      (age_0_14_merged > 0 | age_65_merged > 0) ~ 
        sum(age_0_14_merged,age_65_merged, na.rm = TRUE)/sum(age_15_64_merged,na.rm = TRUE),
      TRUE ~ NA_real_
    ),
    dep_ratio_call_2 =  case_when(
      age_0_17_merged == 0 & age_60_and_more_merged == 0 ~ 0,
      (age_0_17_merged > 0 | age_60_and_more_merged > 0) ~ 
        sum(age_0_17_merged,age_60_and_more_merged, na.rm = TRUE)/sum(age_18_59_merged ,na.rm = TRUE),
      TRUE ~ NA_real_
    ),
    female_lit_call =  case_when(
      female_literacy == 0 ~ 0,
      female_literacy == 0 ~ 
        female_literacy/sum(females_11_17_total,females_18_plus_total, na.rm=TRUE),
      TRUE ~ NA_real_
    ),
    male_lit_call =  case_when(
      male_literacy == 0 ~ 0,
      male_literacy == 0 ~ 
        male_literacy/sum(males_11_17_total,males_18_plus_total, na.rm=TRUE),
      TRUE ~ NA_real_
    ),
    adult_behavior_change_call =  case_when(
      adult_behavior_change == "yes" ~ 1,
      adult_behavior_change == "no" ~ 0,
      TRUE ~ NA_real_
    ),
    child_behavior_change_call =  case_when(
      child_behavior_change == "yes" ~ 1,
      child_behavior_change == "no" ~ 0,
      TRUE ~ NA_real_
    ),
    atleast_one_behav_change_call = case_when(
      child_behavior_change_call == 0 & adult_behavior_change_call == 0 ~ 0,
      child_behavior_change_call > 0 | adult_behavior_change_call > 0 ~ 1,
      TRUE ~ NA_real_
    ),
    adults_working_call = case_when(
      adults_working == 0 ~ 0,
      adults_working > 0 & age_18_64 > 0 ~ adults_working/age_18_64,
      TRUE ~ NA_real_
    ),
    child_working_call = case_when(
      is.na(children_working) ~ 0,
      children_working == 0 ~ 0,
      children_working > 0 & age_10_17 > 0 ~ children_working/age_10_17,
      TRUE ~ NA_real_
    ),
    adult_tazkira_cal = case_when(
      adult_tazkira == 0 ~ "0",
      adult_tazkira >= 1 ~ ">=1",
      TRUE ~ NA_character_
    ),
    child_tazkira_cal = case_when(
      child_tazkira == 0 ~ "0",
      child_tazkira >= 1 ~ ">=1",
      TRUE ~ NA_character_
    ),
    child_tazkira_cal = case_when(
      child_tazkira == 0 ~ "0",
      child_tazkira >= 1 ~ ">=1",
      TRUE ~ NA_character_
    ),
    any_tazkira_cal = case_when(
      adult_tazkira == 0 & child_tazkira == 0~ "0",
      adult_tazkira >= 1 | child_tazkira >= 1~ ">=1",
      TRUE ~ NA_character_
    ),
    insuf_blank_energy = case_when(
      blankets_suff_cal == "<1" & energy_source == "wood" | energy_source == "paper_waste" | energy_source == "animal_waste" ~ "yes",
      TRUE ~ "no"
    ),
    current_presence_mines = case_when(
      displ_explosive_presence == "both" | displ_explosive_presence == "current" |
        nondispl_explosive_presence == "yes" ~ "current_explosive_presence",
      displ_explosive_presence == "previous" | displ_explosive_presence == "no" |
        nondispl_explosive_presence == "no" ~ "no_explosive_presence", 
      TRUE ~ NA_character_
    ),
    
    # child_working_call = case_when(
    #   children_working == 0 ~ 0,
    #   children_working > 0 ~ children_working/age_10_17,
    #   TRUE ~ NA_real_
    # ),
    count_current_enrolled_avg = count_current_enrolled / edu_age_boys_girls_num,
    count_current_attending_avg = count_current_attending / edu_age_boys_girls_num
)

# Major events

major_events_vars <- c(
  "major_events.avalanche",
  "major_events.conflict",
  "major_events.drought",
  "major_events.earthquake",
  "major_events.floods",
  "major_events.other"
)

major_events_score <- (rowSums(data[major_events_vars]))

data <- data %>%
  mutate(
    major_events_cal = case_when(
      major_events_score == 0 ~ "none",
      major_events_score == 1 ~ "1",
      major_events_score == 2 ~ "2",
      major_events_score >= 3 ~ ">= 3",
      TRUE ~ NA_character_
    )
  )



# hno_intersectoral analysis
data <- data %>%
  mutate(
    # GBV incident OR threat
    gbv_incidents_threats = case_when(
      other_incidents == "sgbv" | other_concerns == "sgbv" ~ ">=1",
      (other_incidents == "no" | other_incidents == "other") & 
        (other_concerns == "no" | other_concerns == "other") ~ "0",
      TRUE ~ NA_character_
      ),
    # At least one protection incident for adult OR child
    prot_incident_adult_child = case_when(
      adult_prot_incidents != "none" | child_prot_incidents != "none" ~ ">=1",
      adult_prot_incidents == "none" & child_prot_incidents == "none" ~ "0",
      TRUE ~ NA_character_
    ),
    # Total income per day per household member in USD
    daily_income_hh_members = case_when(
      (((total_income / 30) / hh_size) / 78.36) > 1.90 ~ 1,
      (((total_income / 30) / hh_size) / 78.36) <= 1.90 ~ 0,
      TRUE ~ NA_real_
    ),
    # health
    health_service_access_class = case_when(
      health_facility_access == "no" ~ 1,
      health_facility_access == "yes" ~ 0,
      TRUE ~ NA_real_
    ),
    
    #ESNFI
    shelter_type_access_class = case_when(
      shelter == "tent" | shelter == "makeshift_shelter" | 
        shelter == "collective_centre" | shelter == "open_space" ~ 1,
      shelter == "transitional" | shelter == "permanent" ~ 0,
      TRUE ~ NA_real_
    ),
    
    #EiE
    hh_level_school_attendance_class = case_when(
      count_current_attending > 0 ~ 1,
      TRUE ~ 0
    ),
    
    #FSA No data for Farah paper interviews
    market_service_access_class = case_when(
      market_access == "no" ~ 1,
      market_access == "yes" ~ 0,
      TRUE ~ NA_real_
    ),
    
    #protection
    identity_ownership_class = case_when(
      child_tazkira == 0 & adult_tazkira == 0 ~ 1,
      child_tazkira >=1 | adult_tazkira >=1 ~ 0,
      TRUE ~ NA_real_
    ),
    
    #WASH
    access_to_water_class = case_when(
      water_source == "handpump_private" | water_source == "handpump_public" | 
        water_source == "piped_public" | water_source == "spring_protected" ~ 1,
      water_source == "spring_unprotected" | water_source == "surface_water" | 
        water_source == "water_trucking" | water_source == "other" ~ 0,
      TRUE ~ NA_real_
    )
    
  )

access_services_vars <- c("health_service_access_class", "shelter_type_access_class", 
                          "hh_level_school_attendance_class", "market_service_access_class", 
                          "identity_ownership_class","access_to_water_class") 

data$services_score <- comp_score(data, access_services_vars)

data <- data %>% 
  mutate(
    comp_ind_access_services = case_when(
      services_score <= 2 ~ 0,
      services_score >= 3 ~ 1
    )
  )


#Recoding new variables
data$hh_no_tazkira <- ifelse(data$tazkira_total < 1, "Tazkira_No", "Tazkira_Yes")

data$muac_yes_no <- ifelse(data$muac_total > 0 & !is.na(data$min_muac)  ,"Yes","No")
data$recent_non_recent <- ifelse(data$final_displacement_status_non_displ == "recent_idps", "recent_idps",
                                 ifelse(data$final_displacement_status_non_displ == "non_recent_idps", "non_recent_idps", NA ))
data$edu_removal_shock_cal <-  ifelse(data$shock_class == 5, "Yes", "No") 
data$enrolled_attending <- ifelse(data$count_enrolled_attending > 0, "Enrolled_and_Attending", "Not" ) 
data$schoo_age_boys_girls <- coerc(data$boys_ed) + coerc(data$girls_ed)

## source disaggs
source("r/prepare_disagg.R")


################ MEB analysis ###########################################################

# sustainable income vars
sustainable_income_vars <- c(
  'ag_income',
  'livestock_income',
  'rent_income',
  'small_business_income',
  'unskill_labor_income',
  'skill_labor_income',
  'formal_employment_income',
  'gov_benefits_income'
)

# sustainable income per HH
data$sustainable_income <- comp_score(data, sustainable_income_vars)

# sustainable income per HH member
data$sustainable_income_per_mem <- data$sustainable_income / data$hh_size

# net inocome per hh
data$net_income <- data$sustainable_income - data$all_expenses

# total Exp per hh memeber
data$total_exp_per_mem <- data$all_expenses / data$hh_size

data <- data %>% 
  mutate(
    food_exp_per_mem = food_exp / hh_size,
    water_expt_per_mem = water_expt / hh_size,
    rent_exp_per_mem = rent_exp / hh_size,
    fuel_exp_per_mem = fuel_exp / hh_size,
    debt_exp_per_mem = debt_exp / hh_size, 
    
    food_exp_spent = case_when(
      food_exp > 0 ~ 1,
      food_exp == 0 ~ 0,
      TRUE ~ NA_real_
    ),
    water_expt_spent = case_when(
      water_expt > 0 ~ 1,
      water_expt == 0 ~ 0,
      TRUE ~ NA_real_
    ),
    rent_exp_spent = case_when(
      rent_exp > 0 ~ 1,
      rent_exp == 0 ~ 0,
      TRUE ~ NA_real_
    ),
    fuel_exp_spent = case_when(
      fuel_exp > 0 ~ 1,
      fuel_exp == 0 ~ 0,
      TRUE ~ NA_real_
    ),
    debt_exp_spent = case_when(
      debt_exp > 0 ~ 1,
      debt_exp == 0 ~ 0,
      TRUE ~ NA_real_
    )
  )


# sustainable income 2 vars
sustainable_income_2_vars <- c(
  'ag_income',
  'livestock_income',
  'rent_income',
  'small_business_income',
  'unskill_labor_income',
  'skill_labor_income',
  'formal_employment_income'
)

# sustainable income per HH
data$sustainable_income_2 <- comp_score(data, sustainable_income_2_vars)

# sustainable income per HH member
data$sustainable_income_2_per_mem <- data$sustainable_income_2 / data$hh_size

# unskilled_labor_income per hh member
data$unskill_labor_income_per_mem <- data$unskill_labor_income / data$hh_size


# unskilled + agriculture + livestock income  vars
unskill_ag_live_income_vars <- c(
  'ag_income',
  'livestock_income',
  'unskill_labor_income'
)

# unskilled + agriculture + livestock income 
data$unskill_ag_live_income_income <- comp_score(data, unskill_ag_live_income_vars)

# unskilled + agriculture + livestock income per HH member
data$unskill_ag_live_income_income_per_mem <- data$unskill_ag_live_income_income / data$hh_size


########################################################################################




############################# Vulnerablity composites ###################################

data <- data %>% 
  mutate(
    hoh_disabled_vul_class = case_when(
      data$hoh_disabled == "disabled" ~ 1,
      data$hoh_disabled == "not_disabled" ~ 0,
      TRUE ~ 0
    ),
    hoh_debt_disagg_vul_class = case_when(
      hoh_debt_disagg == "high_debt" ~ 1,
      hoh_debt_disagg == "low_debt" ~ 0,
      hoh_debt_disagg == "medium_debt" ~ 0,
      hoh_debt_disagg == "no_debt" ~ 0,
      TRUE ~ 0
    ),
    tazkira_disagg_vul_class = case_when(
      tazkira_disagg == "non_have_tazkira" ~ 1,
      tazkira_disagg == "all_have_tazkira" ~ 0,
      TRUE ~ 0
    ),
    hoh_age_group_vul_class = case_when(
      hoh_age_group == "65+" ~ 1,
      hoh_age_group == "<65" ~ 0,
      TRUE ~ 0
    ),
    hoh_sex_disagg_vul_class = case_when(
      hoh_sex_disagg == "female" ~ 1, 
      hoh_sex_disagg == "male" ~ 0,
      TRUE ~ 0
    ),
    pregnant_lactating_member_vul_class = case_when(
      pregnant_lactating_member == "at_least_one_mem_pregnant_lactating" ~ 1, 
      pregnant_lactating_member == "no_mem_pregnent_lactating" ~ 0,
      TRUE ~ 0
    ),
    chronic_illness_vul_class = case_when(
      chronic_illness == "yes" ~ 1,
      chronic_illness == "no " ~ 0,
      chronic_illness == "no_answer" ~ 0,
      TRUE ~ 0
    ),
    literacy_vul_class = case_when(
      female_literacy_yes_no == "0" & male_literacy_yes_no == "0"  ~ 1,
      female_literacy_yes_no == "1 or more" ~ 0,
      male_literacy_yes_no == "1 or more" ~ 0,
      TRUE ~ 0
    ),
    behav_change_disagg_vul_class = case_when(
      behav_change_disagg == "yes" ~ 1,
      behav_change_disagg == "no" ~ 0,
      TRUE ~ 0
    ),
    female_literacy_yes_no_class = case_when(
      female_literacy_yes_no == "0" ~ 1,
      female_literacy_yes_no == "1 or more" ~ 0,
      TRUE ~ 0
    ),
    behavior_change_cause_class2 = case_when(
      behavior_change_cause == "yes" ~ 1,
      TRUE ~ 0
    ),
    child_behavior_change_class2 = case_when(
      child_behavior_change == "yes" ~ 1,
      TRUE ~ 0
    ),
    adult_behavior_change_class2 = case_when(
      adult_behavior_change == "yes" ~ 1,
      TRUE ~ 0
    ), 
    adult_behavior_only_by_conflict = case_when(
      adult_behavior_change == "yes" & behavior_change_cause == "yes" ~ 1,
      TRUE  ~ 0
    )
  )


## Vulnerable_group_1
Vulnerable_group_1_vars <- c(
  "hoh_disabled_vul_class",
  "hoh_debt_disagg_vul_class",
  "tazkira_disagg_vul_class",
  "hoh_age_group_vul_class",
  "hoh_sex_disagg_vul_class",
  "chronic_illness_vul_class",
  "literacy_vul_class"
)

data$Vulnerable_group_1_vars_score <- comp_score(data, Vulnerable_group_1_vars)


data <- data %>% 
  mutate(
    vulnerable_group_1 = case_when(
      Vulnerable_group_1_vars_score >= 1 ~ "vulnerable",
      Vulnerable_group_1_vars_score == 0 ~ "not_vulnerable",
      TRUE ~ NA_character_
    )
  )

## vulnerable_group_4
Vulnerable_group_4_vars <- c(
  "hoh_disabled_vul_class",
  "hoh_debt_disagg_vul_class",
  "tazkira_disagg_vul_class",
  "hoh_age_group_vul_class",
  "hoh_sex_disagg_vul_class",
  "behav_change_disagg_vul_class"
)

data$Vulnerable_group_4_vars_score <- comp_score(data, Vulnerable_group_4_vars)


data <- data %>% 
  mutate(
    vulnerable_group_4 = case_when(
      Vulnerable_group_4_vars_score >= 1 ~ "vulnerable",
      Vulnerable_group_4_vars_score == 0 ~ "not_vulnerable",
      TRUE ~ NA_character_
    )
  )


## Vulnerable_group_5
Vulnerable_group_5_vars <- c(
  "hoh_disabled_vul_class",
  "hoh_debt_disagg_vul_class",
  "tazkira_disagg_vul_class",
  "hoh_age_group_vul_class",
  "hoh_sex_disagg_vul_class",
  "pregnant_lactating_member_vul_class",
  "chronic_illness_vul_class",
  "behav_change_disagg_vul_class",
  "literacy_vul_class"
)

data$Vulnerable_group_5_vars_score <- comp_score(data, Vulnerable_group_5_vars)

data <- data %>% 
  mutate(
    vulnerable_group_5 = case_when(
      Vulnerable_group_5_vars_score >= 1 ~ "vulnerable",
      Vulnerable_group_5_vars_score == 0 ~ "not_vulnerable",
      TRUE ~ NA_character_
    )
  )

## Vulnerable_group_6

Vulnerable_group_6_vars <- c(
  "hoh_disabled_vul_class",
  "hoh_debt_disagg_vul_class",
  "tazkira_disagg_vul_class",
  "hoh_age_group_vul_class",
  "hoh_sex_disagg_vul_class",
  "behav_change_disagg_vul_class",
  "female_literacy_yes_no_class"
)

data$Vulnerable_group_6_vars_score <- comp_score(data, Vulnerable_group_6_vars)


data <- data %>% 
  mutate(
    vulnerable_group_6 = case_when(
      Vulnerable_group_6_vars_score >= 1 ~ "vulnerable",
      Vulnerable_group_6_vars_score == 0 ~ "not_vulnerable",
      TRUE ~ NA_character_
    )
  )


## Vulnerable_group_7

## vulnerable_group_7

Vulnerable_group_7_vars <- c(
  "hoh_disabled_vul_class",
  "hoh_debt_disagg_vul_class",
  "tazkira_disagg_vul_class",
  "hoh_age_group_vul_class",
  "hoh_sex_disagg_vul_class",
  "behavior_change_cause_class2"
)

data$Vulnerable_group_7_vars_score <- comp_score(data, Vulnerable_group_7_vars)


data <- data %>% 
  mutate(
    vulnerable_group_7 = case_when(
      Vulnerable_group_7_vars_score >= 1 ~ "vulnerable",
      Vulnerable_group_7_vars_score == 0 ~ "not_vulnerable",
      TRUE ~ NA_character_
    )
  )


## vulnerable_group_8

Vulnerable_group_8_vars <- c(
  "hoh_disabled_vul_class",
  "hoh_debt_disagg_vul_class",
  "tazkira_disagg_vul_class",
  "hoh_age_group_vul_class",
  "hoh_sex_disagg_vul_class",
  "adult_behavior_only_by_conflict"
)

data$Vulnerable_group_8_vars_score <- comp_score(data, Vulnerable_group_8_vars)


data <- data %>% 
  mutate(
    vulnerable_group_8 = case_when(
      Vulnerable_group_8_vars_score >= 1 ~ "vulnerable",
      Vulnerable_group_8_vars_score == 0 ~ "not_vulnerable",
      TRUE ~ NA_character_
    )
  )


###############################################end

#########################
## esnfi_new_indicator_1

data <- data %>% 
  mutate(
    shelter_class2 = case_when(
      shelter == "tent" | shelter == "collective_centre" | shelter == "makeshift_shelter" |
        shelter == "open_space" ~ 1,
      shelter == "transitional" | shelter == "permanent" ~ 0,
      TRUE ~ 0
    ),
    shelter_damage_and_repair_class = case_when(
      (shelter_damage.due_to_conflict == 1 | shelter_damage.due_to_natural_disaster == 1) &
        shelter_damage_repair == "no" ~ 1,
      shelter_damage.no == 1 | shelter_damage_repair == "yes" ~ 0,
      TRUE ~ 0
    ),
    priority_nfi_cal_class = case_when(
      priority_nfi_cal == "0_1" | priority_nfi_cal == "2_3" ~ 1,
      priority_nfi_cal == "4_5" | priority_nfi_cal == "6" ~ 0,
      TRUE ~ 0
      
    )
  )

esnfi_new_indicator_1_vars <- c(
  "shelter_class2",
  "shelter_damage_and_repair_class",
  "priority_nfi_cal_class"
)


esnfi_new_indicator_1_vars_score <- comp_score(data, esnfi_new_indicator_1_vars)

data <- data %>% 
  mutate(
    esnfi_new_indicator_1 = case_when(
      esnfi_new_indicator_1_vars_score >= 1 ~ 1,
      esnfi_new_indicator_1_vars_score == 0 ~ 0,
      TRUE ~ 0
    )
  )

###################################end

######## wash_new_indicator 1#######

data <- data %>% 
  mutate(
    water_source_class2 = case_when(
      water_source == "spring_unprotected" | water_source == "surface_water" | water_source == "water_trucking" |
        water_source == "other" ~ 1,
      water_source == "handpump_private" | water_source == "handpump_public" | water_source == "handpump_public" |
        water_source == "spring_protected" ~ 0,
      TRUE ~ 0
    ),
    latrine_class2 = case_when(
      latrine == "open" | latrine == "pit_latrine_uncovered" | latrine == "other" ~ 1,
      latrine == "public_latrine" | latrine == "pit_latrine_covered" | latrine == "vip_latrine" |
        latrine == "flush_toilet_open_drain" | latrine == "flush_toilet_septic" ~ 0,
      TRUE ~ 0
    ),
    soap_class2 = case_when(
      soap == "no" ~ 1,
      soap == "yes_didnt_see" | soap == "yes_saw" ~ 0,
      TRUE ~ 0
    ),
    diarrhea_cases_class = case_when(
      diarrhea_cases >= 1 ~ 1,
      diarrhea_cases == 0 ~ 0,
      TRUE ~ 0
    ),
    diarrhea_cases_class_children = case_when(
      diarrhea_cases >= 1 ~ 1,
      diarrhea_cases == 0 ~ 0,
      TRUE ~ NA_real_
    )
  )


wash_new_indicator_1_vars <- c(
  "water_source_class2",
  "latrine_class2",
  "soap_class2"
)


wash_new_indicator_1_vars_score <- comp_score(data, wash_new_indicator_1_vars)

data <- data %>% 
  mutate(
    wash_new_indicator_1 = case_when(
      wash_new_indicator_1_vars_score >= 2 ~ 1,
      wash_new_indicator_1_vars_score == 0 ~ 0,
      TRUE ~ 0
    )
  )
##############################################end

######## wash_new_indicator 2 #######

wash_new_indicator_2_vars <- c(
  "water_source_class2",
  "latrine_class2",
  "soap_class2",
  "diarrhea_cases_class"
)


wash_new_indicator_2_vars_score <- comp_score(data, wash_new_indicator_2_vars)

data <- data %>% 
  mutate(
    wash_new_indicator_2 = case_when(
      wash_new_indicator_2_vars_score >= 2 ~ 1,
      wash_new_indicator_2_vars_score == 0 ~ 0,
      TRUE ~ 0
    )
  )

############# winterization_indicator ##################
data <- data %>% 
  mutate(
    shelter_class3 = case_when(
      shelter == "tent" | shelter == "collective_centre" | shelter == "makeshift_shelter" |
        shelter == "open_space" ~ 1,
      shelter == "transitional" | shelter == "permanent" ~ 0,
      TRUE ~ 0
    ),
    blankets_suff_cal_class = case_when(
      blankets_suff_cal == "<1" ~ 1,
      blankets_suff_cal == "1+" ~ 0,
      TRUE ~ 0
    ),
    energy_source_class = case_when(
      energy_source == "animal_waste" | energy_source == "charcoal" | energy_source == "paper_waste" | 
        energy_source == "wood" ~ 1,
      energy_source == "coal" | energy_source == "lpg" | energy_source == "electricity" |
        energy_source == "other" ~ 0,
      TRUE ~ 0
    )
    
  )

winterization_indicator_vars <- c(
  "shelter_class3",
  "blankets_suff_cal_class",
  "energy_source_class"
)


winterization_indicator_vars_score <- comp_score(data, winterization_indicator_vars)

data <- data %>% 
  mutate(
    winterization_indicator = case_when(
      winterization_indicator_vars_score >= 2 ~ 1,
      winterization_indicator_vars_score == 0 ~ 0,
      TRUE ~ 0
    )
  )
################################################end

#################### dip push factors ############

ipd_push_factors_vars <- c(
'idp_push_factors.active_conflict',
'idp_push_factors.anticipated_conflict',
'idp_push_factors.earthquake',
'idp_push_factors.floods',
'idp_push_factors.avalanche',
'idp_push_factors.drought',
'idp_push_factors.poverty',
'idp_push_factors.service_access',
'idp_push_factors.other'
)

ipd_push_factors_vars_short <- c(
  'idp_push_factors.active_conflict',
  'idp_push_factors.anticipated_conflict',
  'idp_push_factors.earthquake',
  'idp_push_factors.floods',
  'idp_push_factors.avalanche',
  'idp_push_factors.drought'
)


data$ipd_push_factors_vars_score <- comp_score(data, ipd_push_factors_vars)
data$ipd_push_factors_vars_score_short <- comp_score(data, ipd_push_factors_vars_short)

data <- data %>% 
  mutate(
    idp_push_factors_cat = case_when(
      ipd_push_factors_vars_score == 1 ~ "1_event",
      ipd_push_factors_vars_score < 3 ~ "2_events",
      ipd_push_factors_vars_score >=3 ~ "3_or_more_events",
      TRUE ~ NA_character_
    ),
    
    idp_push_factors_cat_short = case_when(
      ipd_push_factors_vars_score_short == 1 ~ "1_event",
      ipd_push_factors_vars_score_short < 3 ~ "2_events",
      ipd_push_factors_vars_score_short >=3 ~ "3_or_more_events",
      TRUE ~ NA_character_
    )
    
  )


##################### MSNI #######################

#### IMPACT 

data <- data %>% 
  mutate(
    major_events_impc = case_when(
      major_events_cal == ">= 3" | major_events_cal == "2" ~ 3,
      major_events_cal == "1" ~ 1, 
      TRUE ~ 0
    ),
    agricultural_impact_how_impc = case_when(
      agricultural_impact_how == "51_75" ~ 1,
      agricultural_impact_how == "76_100" ~ 2,
      TRUE ~ 0
    ), 
    livestock_impact_how_impc = case_when(
      livestock_impact_how.livestock_died == 1 ~ 1,
      livestock_impact_how.left_unattended == 1 ~ 1,
      TRUE ~ 0
    ),
    explosive_impact_death_impc = case_when(
      explosive_impact.injury_death == 1 ~ 3,
      TRUE ~ 0
    ),
    explosive_impact_others_impc = case_when(
      explosive_impact.psych_impact == 1 | explosive_impact.relocation == 1 |
        explosive_impact.access_services == 1 | explosive_impact.restrict_recreation == 1 |
        explosive_impact.livelihoods_impact == 1 | explosive_impact.other == 1 &
        explosive_impact.injury_death != 1 ~ 2,
      TRUE ~ 0
    ),
    adult_injuries_cause_impc = case_when(
      adult_injuries_cause == "conflict" | adult_injuries_cause == "natural_disaster" |
        child_injuries_cause == "conflict" | child_injuries_cause == "natural_disaster" ~ 3,
      TRUE ~ 0
    ),
    shelter_damage_impc = case_when(
      shelter_damage == "due_to_conflict" | shelter_damage == "due_to_natural_disaster" ~ 2,
      TRUE ~ 0 
    ),
    edu_removal_shock_impc = case_when(
      count_shock >= 1 ~ 1,
      TRUE ~ 0
    ),
    health_facility_reopened_impc = case_when(
      health_facility_reopened == "remain_closed" ~ 1,
      TRUE ~ 0
    ),
    water_damaged_cause_impc = case_when(
      water_damaged_cause == "conflict" | water_damaged_cause == "natural_disaster" |
        water_damaged_cause == "drought" ~ 2,
      TRUE ~ 0
    ),
    aid_access_issue_2_impc = case_when(
      aid_access_issue == "yes" & aid_access_issue_type == "insecurity" |
        aid_access_issue_type == "explosive_hazards" ~ 2,
      TRUE ~ 0
    ),
    aid_access_issue_1_impc = case_when(
      aid_access_issue == "yes" & aid_access_issue_type == "distance" |
        aid_access_issue_type == "social_restrictions" ~ 1,
      TRUE ~ 0 
    )
  )

# impact class vars
msni_impact_score_vars <- c(
  "major_events_impc",
  "agricultural_impact_how_impc",
  "livestock_impact_how_impc",
  "explosive_impact_death_impc",
  "explosive_impact_others_impc",
  "adult_injuries_cause_impc",
  "shelter_damage_impc",
  "edu_removal_shock_impc",
  "health_facility_reopened_impc",
  "water_damaged_cause_impc",
  "aid_access_issue_2_impc",
  "aid_access_issue_1_impc"
)

# impact score
data$msni_impact_score <- comp_score(data, msni_impact_score_vars)

# impact severity
data <- data %>% 
  mutate(
    impact = case_when(
      msni_impact_score < 3 ~ 1,
      msni_impact_score > 2 & msni_impact_score < 6 ~ 2,
      msni_impact_score > 5 & msni_impact_score < 9 ~ 3,
      msni_impact_score >= 9 ~ 4,
      TRUE ~ 0
    )
  )


#### End IMPACT 


#### Capacity gaps

data <- data %>% 
  mutate(
    capacity_gaps = case_when(
      lcsi_severity == "minimal" ~ 1,
      lcsi_severity == "stress" ~ 2,
      lcsi_severity == "severe" ~ 3,
      lcsi_severity == "extreme" ~ 4,
      TRUE ~ NA_real_
    )
  )

#### End Capacity gaps


# HC-LSG/ESNFI - shelter_lsg


data <- data %>% 
  mutate(
    shelter_type_lsg = case_when(
      shelter == "open_space" ~ 3,
      shelter == "tent" | shelter == "makeshift_shelter" | shelter == "collective_centre" ~ 2,
      # shelter == "transitional" ~ 1,
      TRUE ~ 0
    ),
    shelter_damage_lsg = case_when(
      shelter_damage_extent == "fully_destroyed" & shelter_damage_repair == "no" ~ 3,
      shelter_damage_extent == "significant_damage" & shelter_damage_repair == "no" ~ 2,
      TRUE ~ 0
    ),
    winterisation_lsg = case_when(
      blankets_suff_cal == "<1" & (energy_source == "animal_waste" | energy_source == "paper_waste" | 
        energy_source == "wood") ~ 3,
      TRUE ~ 0
    ),
    access_nfi_lsg = case_when(
      priority_nfi_num < 3 ~ 3,
      priority_nfi_num > 2 & priority_nfi_num < 6 ~ 2,
      TRUE ~ 0
    )
  )


# shelter_lsg class vars
msni_shelter_lsg_vars <- c(
  "shelter_type_lsg",
  "shelter_damage_lsg",
  "winterisation_lsg",
  "access_nfi_lsg"
)

# shelter_lsg score
data$msni_shelter_lsg_score <- comp_score(data, msni_shelter_lsg_vars)

# shelter_lsg severity
data <- data %>% 
  mutate(
    shelter_lsg = case_when(
      msni_shelter_lsg_score < 3 ~ 1,
      msni_shelter_lsg_score > 2 & msni_shelter_lsg_score < 6 ~ 2,
      msni_shelter_lsg_score > 5 & msni_shelter_lsg_score < 9 ~ 3,
      msni_shelter_lsg_score >= 9 ~ 4
    )
  )
#### end shelter_lsg


# HC-LSG/FSA - fsl_lsg

data <- data %>% 
  mutate(
    fcs_lsg = case_when(
      fcs_category == "poor" ~ 3,
      fcs_category == "borderline" ~ 2,
      TRUE ~ 0
    ),
    hhs_lsg = case_when(
      hhs_category == "severe_hunger" ~ 3,
      hhs_category == "moderate_hunger" ~ 2,
      TRUE ~ 0
    ),
    food_source_lsg = case_when(
      food_source == "assistance" | food_source == "gift" | food_source == "borrowed" ~ 3,
      # food_source == "borrowed" ~ 2,
      TRUE ~ 0
    ),
    market_access_lsg = case_when(
      market_access == "no" ~ 3,
      TRUE ~ 0
    ),
    market_distance_lsg = case_when(
      market_distance == "6_10km" ~ 2,
      TRUE ~ 0
    )
  )

# fsl_lsg class vars
msni_fsl_lsg_vars <- c(
  "fcs_lsg",
  "hhs_lsg",
  "food_source_lsg",
  "market_access_lsg",
  "market_distance_lsg"
)

# fsl_lsg score
data$msni_fsl_lsg_score <- comp_score(data, msni_fsl_lsg_vars)

# fsl_lsg severity
data <- data %>% 
  mutate(
    fsl_lsg = case_when(
      msni_fsl_lsg_score < 3 ~ 1,
      msni_fsl_lsg_score > 2 & msni_fsl_lsg_score < 6 ~ 2,
      msni_fsl_lsg_score > 5 & msni_fsl_lsg_score < 9 ~ 3,
      msni_fsl_lsg_score >= 9 ~ 4
    )
  )

# fsl_lsg severity 2
data <- data %>% 
  mutate(
    fsl_lsg_2 = case_when(
      msni_fsl_lsg_score < 3 ~ 1,
      msni_fsl_lsg_score > 2 & msni_fsl_lsg_score < 7 ~ 2,
      msni_fsl_lsg_score > 6 & msni_fsl_lsg_score < 9 ~ 3,
      msni_fsl_lsg_score >= 9 ~ 4
    )
  )

# fsl_lsg severity 3
data <- data %>% 
  mutate(
    fsl_lsg_3 = case_when(
      msni_fsl_lsg_score < 3 ~ 1,
      msni_fsl_lsg_score > 2 & msni_fsl_lsg_score < 8 ~ 2,
      msni_fsl_lsg_score > 7 & msni_fsl_lsg_score < 10 ~ 3,
      msni_fsl_lsg_score >= 10 ~ 4
    )
  )
  
#### end fsl_lsg


# HC-LSG/Health - health_lsg

data <- data %>% 
  mutate(
    access_health_center_lsg = case_when(
      health_facility_access == "no" ~ 3,
      TRUE ~ 0
    ),
    health_facility_distance_lsg = case_when(
      health_facility_distance == "none" | health_facility_distance == "more_10km" ~ 3,
      health_facility_distance == "6_10km" ~ 2,
      TRUE ~ 0
    ),
    behav_change_lsg = case_when(
      behav_change_disagg == "yes" ~ 3,
      TRUE ~ 0
    ),
    birth_location_lsg = case_when(
      birth_location == "outside" | diarrhea_cases_class == 1 ~ 3,
      birth_location == "home" | birth_location == "midwife_home" | birth_location == "other" ~ 2,
      TRUE ~ 0
    )
  )

# health_lsg class vars
msni_health_lsg_vars <- c(
  "access_health_center_lsg",
  "health_facility_distance_lsg",
  "behav_change_lsg",
  "birth_location_lsg"
)

# health_lsg score
data$msni_health_lsg_score <- comp_score(data, msni_health_lsg_vars)

# health_lsg severity
data <- data %>% 
  mutate(
    health_lsg = case_when(
      msni_health_lsg_score < 3 ~ 1,
      msni_health_lsg_score > 2 & msni_health_lsg_score < 6 ~ 2,
      msni_health_lsg_score > 5 & msni_health_lsg_score < 9 ~ 3,
      msni_health_lsg_score >= 9 ~ 4
    )
  )

#### end health_lsg


# HC-LSG/Protection - protection_lsg

data <- data %>% 
  mutate(
    prot_incidents_4_lsg = case_when(
      adult_prot_incidents.assaulted_with_weapon == 1 | adult_prot_incidents.hindered_leave_settlement == 1 |
        adult_prot_incidents.forced_work == 1 | adult_prot_incidents.forcibly_detained == 1 |
        child_prot_incidents.assaulted_with_weapon == 1 | child_prot_incidents.hindered_leave_settlement == 1 |
        child_prot_incidents.forced_work == 1 | child_prot_incidents.forcibly_detained == 1 ~ 4,
      TRUE ~ 0
    ),
    prot_incidents_3_lsg = case_when(
      adult_prot_incidents.verbally_threatened == 1 | adult_prot_incidents.assaulted_without_weapon == 1 |
        adult_prot_incidents.hindered_leave_district == 1 | child_prot_incidents.verbally_threatened == 1 |
        child_prot_incidents.assaulted_without_weapon == 1 | child_prot_incidents.hindered_leave_district == 1 &
           (adult_prot_incidents.assaulted_with_weapon == 0 | adult_prot_incidents.hindered_leave_settlement == 0 |
            adult_prot_incidents.forced_work == 0 | adult_prot_incidents.forcibly_detained == 0 |
            child_prot_incidents.assaulted_with_weapon == 0 | child_prot_incidents.hindered_leave_settlement == 0 |
            child_prot_incidents.forced_work == 0 | child_prot_incidents.forcibly_detained == 0) ~ 3,
      TRUE ~ 0
    ),
    other_incidents_lsg = case_when(
      other_incidents == "sgbv" | other_concerns == "sgbv" | boy_marriage == "yes" | girl_marriage == "yes" ~ 3,
      TRUE ~ 0
    ),
    prot_concerns_lsg = case_when(
      prot_concerns.violence_maiming == 1 | prot_concerns.violence_injuries == 1 | prot_concerns.psych_wellbeing == 1 |
        prot_concerns.abduction == 1 | prot_concerns.theft == 1 | prot_concerns.explosive_hazards == 1 |
        prot_concerns.destruction_property == 1 | prot_concerns.early_marriage == 1 | prot_concerns.other == 1 ~ 3,
      TRUE ~ 0
    ),
    safety_lsg = case_when(
      safety == "poor" | safety == "very_poor" ~ 2,
      TRUE ~ 0
    )
  )

# protection_lsg class vars
msni_protection_lsg_vars <- c(
  "prot_incidents_4_lsg",
  "prot_incidents_3_lsg",
  "other_incidents_lsg",
  "prot_concerns_lsg",
  "safety_lsg"
)

# protection_lsg score
data$msni_protection_lsg_score <- comp_score(data, msni_protection_lsg_vars)

# protection_lsg severity
data <- data %>% 
  mutate(
    protection_lsg = case_when(
      msni_protection_lsg_score < 3 ~ 1,
      msni_protection_lsg_score > 2 & msni_protection_lsg_score < 6 ~ 2,
      msni_protection_lsg_score > 5 & msni_protection_lsg_score < 9 ~ 3,
      msni_protection_lsg_score >= 9 ~ 4
    )
  )

#### end protection_lsg


# HC-LSG/WASH wash_lsg

data <- data %>% 
  mutate(
    water_source_lsg = case_when(
      water_source == "surface_water" ~ 3,
      water_source == "water_trucking" | water_source == "spring_unprotected" ~ 2, 
      TRUE ~ 0
    ),
    soap_lsg = case_when(
      soap == "no" ~ 3,
      TRUE ~ 0
    ),
    latrine_lsg = case_when(
      latrine == "open" | latrine == "public_latrine" | waste_disposal == "open_space" ~ 3,
      latrine == "pit_latrine_uncovered" | waste_disposal == "burning" ~ 2,
      TRUE ~ 0
    ),
    water_distance_lsg = case_when(
      water_distance == "over_1km" ~ 3,
      water_distance == "500m_to_1km" ~ 2,
      TRUE ~ 0
    )
  )

# wash_lsg class vars
msni_wash_lsg_vars <- c(
  "water_source_lsg",
  "soap_lsg",
  "latrine_lsg",
  "water_distance_lsg"
)

# wash_lsg score
data$msni_wash_lsg_score <- comp_score(data, msni_wash_lsg_vars)

# wash_lsg severity
data <- data %>% 
  mutate(
    wash_lsg = case_when(
      msni_wash_lsg_score < 3 ~ 1,
      msni_wash_lsg_score > 2 & msni_wash_lsg_score < 6 ~ 2,
      msni_wash_lsg_score > 5 & msni_wash_lsg_score < 9 ~ 3,
      msni_wash_lsg_score >= 9 ~ 4
    )
  )

# wash_lsg severity 2
data <- data %>% 
  mutate(
    wash_lsg_2 = case_when(
      msni_wash_lsg_score < 3 ~ 1,
      msni_wash_lsg_score > 2 & msni_wash_lsg_score < 7 ~ 2,
      msni_wash_lsg_score > 6 & msni_wash_lsg_score < 9 ~ 3,
      msni_wash_lsg_score >= 9 ~ 4
    )
  )

# wash_lsg severity 3
data <- data %>% 
  mutate(
    wash_lsg_3 = case_when(
      msni_wash_lsg_score < 3 ~ 1,
      msni_wash_lsg_score > 2 & msni_wash_lsg_score < 8 ~ 2,
      msni_wash_lsg_score > 7 & msni_wash_lsg_score < 10 ~ 3,
      msni_wash_lsg_score >= 10 ~ 4
    )
  )

#### end wash_lsg


# HC-LSG/EiE - education_lsg

data <- data %>% 
  mutate(
    not_attending_lsg = case_when(
    percent_enrolled >= 0.75 & percent_enrolled <= 1 ~ 4,
    percent_enrolled >= 0.5 & percent_enrolled <= 0.749 ~ 3,
    percent_enrolled >= 0.25 & percent_enrolled <= 0.449 ~ 2,
    percent_enrolled >= 0 & percent_enrolled <= 0.249 ~ 1,
    TRUE ~ 0
    ),
    education_level_lsg = case_when(
      highest_edu == "none" ~ 2,
      highest_edu == "primary" ~ 1,
      TRUE ~ 0
    ),
    unattending_security_lsg = case_when(
      boy_unattendance_reason.insecurity == 1 | boy_unattendance_reason.child_works_instead == 1 |
        girl_unattendance_reason.insecurity == 1 | girl_unattendance_reason.child_works_instead == 1 ~ 3,
      TRUE ~ 0
    ),
    unattending_cultural_lsg = case_when(
      boy_unattendance_reason.cultural_reasons == 1 | girl_unattendance_reason == 1 |
        boy_unattendance_reason.lack_facilities == 1 | girl_unattendance_reason.lack_facilities == 1 ~ 2,
      TRUE ~ 0
    ),
    unattending_finance_doc_lsg = case_when(
      boy_unattendance_reason.lack_documentation == 1 | boy_unattendance_reason.too_expensive == 1 |
        boy_unattendance_reason.lack_teachers == 1 | girl_unattendance_reason.lack_documentation ==1 |
        girl_unattendance_reason.too_expensive == 1 | girl_unattendance_reason.lack_teachers == 1 ~ 1,
      TRUE ~ 0
    )
  )


# education_lsg class vars
msni_education_lsg_vars <- c(
  "not_attending_lsg",
  "unattending_security_lsg",
  "unattending_cultural_lsg",
  "unattending_finance_doc_lsg",
  "education_level_lsg"
)

# education_lsg score
data$msni_education_lsg_score <- comp_score(data, msni_education_lsg_vars)

# education_lsg severity
data <- data %>% 
  mutate(
    education_lsg = case_when(
      msni_education_lsg_score < 3 ~ 1,
      msni_education_lsg_score > 2 & msni_education_lsg_score < 6 ~ 2,
      msni_education_lsg_score > 5 & msni_education_lsg_score < 9 ~ 3,
      msni_education_lsg_score >= 9 ~ 4
    )
  )

#### end education_lsg

#################################################
data <- data %>% filter(!is.na(province))

# fliter prolematic feilds
uuid_filter <- c("ac3e8430-ba88-497b-9895-c1bd8da7f79e",
                 "8ac61e9b-8ff8-4e4a-9619-1dc0ab31f396", 
                 "7171e0a8-3a40-4c57-b84d-a65f08115994",
                 "596c244b-ea20-48ef-8218-023ac3f2831f")

`%notin%` <- Negate(`%in%`)
data <- data %>% filter(uuid %notin% uuid_filter )


# MSNI Indicator
data$msni <- msni(education_lsg = data$education_lsg,
                  fsl_lsg = data$fsl_lsg,
                  health_lsg = data$health_lsg,
                  protection_lsg = data$protection_lsg,
                  shelter_lsg = data$shelter_lsg,
                  wash_lsg = data$wash_lsg, 
                  capacity_gaps = data$capacity_gaps,
                  impact = data$impact)

data$msni2 <- msni(education_lsg = data$education_lsg,
                  fsl_lsg = data$fsl_lsg_2,
                  health_lsg = data$health_lsg,
                  protection_lsg = data$protection_lsg,
                  shelter_lsg = data$shelter_lsg,
                  wash_lsg = data$wash_lsg_2, 
                  capacity_gaps = data$capacity_gaps,
                  impact = data$impact)

data$msni3 <- msni(education_lsg = data$education_lsg,
                  fsl_lsg = data$fsl_lsg_3,
                  health_lsg = data$health_lsg,
                  protection_lsg = data$protection_lsg,
                  shelter_lsg = data$shelter_lsg,
                  wash_lsg = data$wash_lsg_3, 
                  capacity_gaps = data$capacity_gaps,
                  impact = data$impact)


data$msni_sev_high <- ifelse(data$msni==3|data$msni==4,1,0)


# HHs found to have severe or extreme sectoral needs in one or more sectors
# lsg_needs_2_cal
data <- data %>% 
  mutate( 
    shelter_lsg_class = case_when(
      shelter_lsg == 3 | shelter_lsg == 4 ~ 1,
      shelter_lsg == 1 | shelter_lsg == 2 ~ 0,
      TRUE ~ NA_real_
    ),
    fsl_lsg_class = case_when(
      fsl_lsg == 3 | fsl_lsg == 4 ~ 1,
      fsl_lsg == 1 | fsl_lsg == 2 ~ 0,
      TRUE ~ NA_real_
    ),
    health_lsg_class = case_when(
      health_lsg == 3 | health_lsg == 4 ~ 1,
      health_lsg == 1 | health_lsg == 2 ~ 0,
      TRUE ~ NA_real_
    ), 
    protection_lsg_class = case_when(
      protection_lsg == 3 | protection_lsg == 4 ~ 1,
      protection_lsg == 1 | protection_lsg == 2 ~ 0,
      TRUE ~ NA_real_
    ),
    wash_lsg_class = case_when(
      wash_lsg == 3 | wash_lsg == 4 ~ 1,
      wash_lsg == 1 | wash_lsg == 2 ~ 0,
      TRUE ~ NA_real_
    ),
    education_lsg = case_when(
      education_lsg == 3 | education_lsg == 4 ~ 1,
      education_lsg == 1 | education_lsg == 2 ~ 0,
      TRUE ~ NA_real_
    )
  )

lsg_needs_2_cal_vars <- c(
  "shelter_lsg_class",
  "fsl_lsg_class",
  "health_lsg_class",
  "protection_lsg_class",
  "wash_lsg_class",
  "education_lsg"
)

# lsg_needs_2_cal score
data$lsg_needs_2_cal_score <- comp_score(data, lsg_needs_2_cal_vars)

# lsg_needs_2_cal
data <- data %>% 
  mutate(
    lsg_needs_2_cal = case_when(
      lsg_needs_2_cal_score == 0 ~ "no_need",
      lsg_needs_2_cal_score == 1 ~ "one_need",
      lsg_needs_2_cal_score > 1 ~ "two_or_more_need"
      )
    )



# msni drivers
data <- data %>% 
  mutate(
    fsl_wash_driver = case_when(
      fsl_lsg == 3 | fsl_lsg == 4 | wash_lsg == 3 | wash_lsg == 4 ~ "sectoral_need",
      fsl_lsg == 1 | fsl_lsg == 2 | wash_lsg == 1 | wash_lsg == 2 ~ "no_need",
      TRUE ~ NA_character_
    ),
    impact_driver = case_when(
      ((impact == 3 | impact == 4) & (health_lsg == 3 | health_lsg == 4)) |
      ((impact == 3 | impact == 4) & (shelter_lsg == 3 | shelter_lsg == 4)) |
      ((impact == 3 | impact == 4) & (protection_lsg == 3 | protection_lsg == 4)) ~ "sectoral_need",
      TRUE ~ "no_need"
    ),
    shelter_driver_class = case_when(
      shelter_lsg == 3 | shelter_lsg == 4 ~ 1,
      TRUE ~ 0,
    ), 
    protection_driver_class = case_when(
      protection_lsg == 3 | protection_lsg == 4 ~ 1,
      TRUE ~ 0
    ),
    health_driver_class = case_when(
      health_lsg == 3 | health_lsg == 4 ~ 1,
      TRUE ~ 0
    ),
    capacity_gaps_sev = case_when(
      capacity_gaps >=3 ~ "high",
      capacity_gaps <=2 ~ "low",
      TRUE ~ NA_character_
    )
  )

# esnfi_prot_health_driver
esnfi_prot_health_driver_vars <- c(
  "shelter_driver_class",
  "protection_driver_class",
  "health_driver_class"
)

# esnfi_prot_health_driver score
data$esnfi_prot_health_driver_score <- comp_score(data, esnfi_prot_health_driver_vars)

# lsg_needs_2_cal
data <- data %>% 
  mutate(
    esnfi_prot_health_driver = case_when(
      esnfi_prot_health_driver_score <= 1 ~ "no_need",
      esnfi_prot_health_driver_score >= 2 ~ "sectoral_need",
    )
  )


############### MSNI TEST ###############  

data <- data %>% 
  mutate(
    hh_msni_one = case_when(
      education_lsg == 1 & fsl_lsg == 1 & health_lsg == 1  & protection_lsg == 1 & shelter_lsg == 1  & wash_lsg == 1  &
      capacity_gaps == 1 & impact == 1 ~ "1",
      TRUE ~ "1+"
    ), 
    hh_msni_one_only_sectors = case_when(
      education_lsg == 1 & fsl_lsg == 1 & health_lsg == 1  & protection_lsg == 1 & shelter_lsg == 1  & wash_lsg == 1 ~ "1",
      TRUE ~ "1+"
    )
  )

#########################################

#join main dataset var to hh roster
data_sub <- data %>% select(final_displacement_status_non_displ, region_disagg, urban_disagg,
                            hoh_sex_disagg, hoh_disabled_disagg, hoh_chronic_illness_disagg, hoh_elderly_disagg,
                            displacements_disagg, literate_adult_disagg, lcsi_disagg, host_disagg, disp_length_disagg, hoh_sex2_disagg,
                            behav_change_disagg, child_behav_change_disagg,
                            tazkira_disagg3, hoh_debt_disagg , vulnerable_group_4, vulnerable_group_7, registered_dissagg, informal_settlement,
                            child_tazkira_disagg, uuid)

overall_hh_roster <- overall_hh_roster %>%
mutate(
  school_age = case_when(
    hh_member_age >=6 & hh_member_age <= 18 ~ "school_age",
    TRUE ~ "not_school_age"
  ),
  current_year_attending_na_no = case_when(
    current_year_attending == "no" ~ "no",
    current_year_attending == "yes" ~ "yes",
    TRUE & school_age == "school_age" ~ "no"
  ),
  edu_removal_shock.no_sch_age = case_when(
    edu_removal_shock.no == 1 ~ 1,
    TRUE & school_age == "school_age" ~ 0
  ),
  edu_removal_shock.conflict_sch_age = case_when(
    edu_removal_shock.conflict == 1 ~ 1, 
    TRUE & school_age == "school_age" ~ 0
  ),
  edu_removal_shock.displacement_sch_age = case_when(
    edu_removal_shock.displacement == 1 ~ 1,
    TRUE & school_age == "school_age" ~ 0
  ),
  edu_removal_shock.natural_disaster_sch_age = case_when(
    edu_removal_shock.natural_disaster == 1 ~ 1,
    TRUE & school_age == "school_age" ~ 0
  ),
  edu_removal_shock_sch_age = case_when(
    edu_removal_shock.no == 1 ~ "yes",
    TRUE & school_age == "school_age" ~ "no"
  ),
  hh_member_age_cat = case_when(
    hh_member_age >= 0 & hh_member_age < 6 ~ "0_5",
    hh_member_age > 5 & hh_member_age < 19 ~ "6_18",
    hh_member_age > 18 & hh_member_age < 60 ~ "19_59",
    hh_member_age > 59 ~ "60+"
  ),
  # demographic hh roster data
  hh_member_age_cat_gender = case_when(
    hh_member_age >= 0 & hh_member_age < 6 & hh_member_sex == "female" ~ "female_0_5",
    hh_member_age >= 0 & hh_member_age < 6 & hh_member_sex == "male" ~ "male_0_5",
    hh_member_age > 5 & hh_member_age < 19 & hh_member_sex == "female" ~ "female_6_18",
    hh_member_age > 5 & hh_member_age < 19 & hh_member_sex == "male" ~ "male_6_18",
    hh_member_age > 18 & hh_member_age < 60 & hh_member_sex == "female" ~ "female_19_59",
    hh_member_age > 18 & hh_member_age < 60 & hh_member_sex == "male" ~ "male_19_59",
    hh_member_age > 59 & hh_member_sex == "female" ~ "female_60+",
    hh_member_age > 59 & hh_member_sex == "male" ~ "male_60+"
    
  ),
  male_female_perc = case_when(
    hh_member_sex == "female" ~ "female",
    hh_member_sex == "male" ~ "male"
  ),
  ## request # 30
  school_age_cat_gender = case_when(
    
    hh_member_age > 5 & hh_member_age < 13 & hh_member_sex == "female" ~ "female_6_12",
    hh_member_age > 12 & hh_member_age < 19 & hh_member_sex == "female" ~ "female_13_18",
    hh_member_age > 5 & hh_member_age < 13 & hh_member_sex == "male" ~ "male_6_12",
    hh_member_age > 12 & hh_member_age < 19 & hh_member_sex == "male" ~ "male_13_18",
    TRUE ~ NA_character_
  )
  
)
############## demographic hoh data #####################
hoh_data <- data %>%
  select(
    hh_member_sex = hoh_sex,
    hh_member_age = hoh_age,
    `_submission__uuid` = uuid,
    province,
    survey_village) %>%
  mutate(
    hh_member_age_cat_gender = case_when(
      hh_member_age >= 0 & hh_member_age < 6 & hh_member_sex == "female" ~ "female_0_5",
      hh_member_age >= 0 & hh_member_age < 6 & hh_member_sex == "male" ~ "male_0_5",
      hh_member_age > 5 & hh_member_age < 19 & hh_member_sex == "female" ~ "female_6_18",
      hh_member_age > 5 & hh_member_age < 19 & hh_member_sex == "male" ~ "male_6_18",
      hh_member_age > 18 & hh_member_age < 60 & hh_member_sex == "female" ~ "female_19_59",
      hh_member_age > 18 & hh_member_age < 60 & hh_member_sex == "male" ~ "male_19_59",
      hh_member_age > 59 & hh_member_sex == "female" ~ "female_60+",
      hh_member_age > 59 & hh_member_sex == "male" ~ "male_60+"
    ),
    male_female_perc = case_when(
      hh_member_sex == "female" ~ "female",
      hh_member_sex == "male" ~ "male"
    ),
    school_age_cat_gender = case_when(
      
      hh_member_age > 5 & hh_member_age < 13 & hh_member_sex == "female" ~ "female_6_12",
      hh_member_age > 12 & hh_member_age < 19 & hh_member_sex == "female" ~ "female_13_18",
      hh_member_age > 5 & hh_member_age < 13 & hh_member_sex == "male" ~ "male_6_12",
      hh_member_age > 12 & hh_member_age < 19 & hh_member_sex == "male" ~ "male_13_18",
      TRUE ~ NA_character_
    )
  )
hoh_data <- hoh_data %>%
  select(
    hh_member_sex,
    hh_member_age,
    hh_member_age_cat_gender,
    male_female_perc,
    school_age_cat_gender,
    province,
    survey_village,
    `_submission__uuid`
  )

roster_data <- overall_hh_roster %>%
  select(
    hh_member_sex,
    hh_member_age,
    hh_member_age_cat_gender,
    male_female_perc,
    school_age_cat_gender,
    province,
    survey_village,
    `_submission__uuid`
  )

combined_hoh_and_roster <- rbind(roster_data, hoh_data)

# for demographic
combined_hoh_and_roster_joined <- koboloops::add_parent_to_loop(combined_hoh_and_roster, data_sub, uuid.name.loop = "_submission__uuid", uuid.name.parent = "uuid")
combined_hoh_and_roster_joined <- combined_hoh_and_roster_joined %>% 
  mutate(
    hh_member_under_over_15 = case_when(
      hh_member_age <= 15 ~ "15_and_under",
      hh_member_age > 15 ~ "over_15",
      TRUE ~ NA_character_
    )
  )


write.csv(combined_hoh_and_roster_joined, "./input/data/recoded/hh_roster_hoh_demographic.csv", row.names = F)



# for education questions
hh_roster_joined <- koboloops::add_parent_to_loop(overall_hh_roster, data_sub, uuid.name.loop = "_submission__uuid", uuid.name.parent = "uuid")
write.csv(hh_roster_joined, "./input/data/recoded/hh_roster.csv", row.names = F)




write.csv(data, "./input/data/recoded/data_with_strata2.csv", row.names = F)

## Test
